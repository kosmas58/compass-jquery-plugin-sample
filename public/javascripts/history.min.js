/*
 New BSD License <http://creativecommons.org/licenses/BSD/>
 Public Domain
 @author Benjamin Arthur Lupton <contact@balupton.com>
 @author James Padolsey <https://gist.github.com/527683>
 Public Domain
 @author Benjamin Arthur Lupton <contact@balupton.com>
*/
(function(f,l){var j=f.console||l,g=f.document,k=f.navigator,m=f.amplify||false,p=f.setTimeout,q=f.clearTimeout,r=f.setInterval,i=f.JSON,a=f.History=f.History||{},n=f.history;i.stringify=i.stringify||i.encode;i.parse=i.parse||i.decode;if(typeof a.init!=="undefined")throw Error("History.js Core has already been loaded...");a.init=function(){if(typeof a.Adapter==="undefined")return false;typeof a.initCore!=="undefined"&&a.initCore();typeof a.initHtml4!=="undefined"&&a.initHtml4();return true};a.initCore=
function(){if(typeof a.initCore.initialized!=="undefined")return false;else a.initCore.initialized=true;a.options=a.options||{};a.options.hashChangeInterval=a.options.hashChangeInterval||100;a.options.safariPollInterval=a.options.safariPollInterval||500;a.options.doubleCheckInterval=a.options.doubleCheckInterval||500;a.options.storeInterval=a.options.storeInterval||1E3;a.options.busyDelay=a.options.busyDelay||250;a.options.debug=a.options.debug||false;a.options.initialTitle=a.options.initialTitle||
g.title;a.debug=function(){a.options.debug&&a.log.apply(a,arguments)};a.log=function(){var b=!(typeof j==="undefined"||typeof j.log==="undefined"||typeof j.log.apply==="undefined"),c=g.getElementById("log"),d,e,h;if(b){e=Array.prototype.slice.call(arguments);d=e.shift();typeof j.debug!=="undefined"?j.debug.apply(j,[d,e]):j.log.apply(j,[d,e])}else d="\n"+arguments[0]+"\n";e=1;for(h=arguments.length;e<h;++e){var o=arguments[e];if(typeof o==="object"&&typeof i!=="undefined")try{o=i.stringify(o)}catch(t){}d+=
"\n"+o+"\n"}if(c){c.value+=d+"\n-----\n";c.scrollTop=c.scrollHeight-c.clientHeight}else b||alert(d);return true};a.getInternetExplorerMajorVersion=function(){return a.getInternetExplorerMajorVersion.cached=typeof a.getInternetExplorerMajorVersion.cached!=="undefined"?a.getInternetExplorerMajorVersion.cached:function(){for(var b=3,c=g.createElement("div"),d=c.getElementsByTagName("i");(c.innerHTML="<!--[if gt IE "+ ++b+"]><i></i><![endif]--\>")&&d[0];);return b>4?b:false}()};a.isInternetExplorer=function(){return a.isInternetExplorer.cached=
typeof a.isInternetExplorer.cached!=="undefined"?a.isInternetExplorer.cached:Boolean(a.getInternetExplorerMajorVersion())};a.emulated={pushState:!Boolean(f.history&&f.history.pushState&&f.history.replaceState&&!(/ Mobile\/([1-7][a-z]|(8([abcde]|f(1[0-8]))))/i.test(k.userAgent)||/AppleWebKit\/5([0-2]|3[0-2])/i.test(k.userAgent))),hashChange:Boolean(!("onhashchange"in f||"onhashchange"in g)||a.isInternetExplorer()&&a.getInternetExplorerMajorVersion()<8)};a.enabled=!a.emulated.pushState;a.bugs={setHash:Boolean(!a.emulated.pushState&&
k.vendor==="Apple Computer, Inc."&&/AppleWebKit\/5([0-2]|3[0-3])/.test(k.userAgent)),safariPoll:Boolean(!a.emulated.pushState&&k.vendor==="Apple Computer, Inc."&&/AppleWebKit\/5([0-2]|3[0-3])/.test(k.userAgent)),ieDoubleCheck:Boolean(a.isInternetExplorer()&&a.getInternetExplorerMajorVersion()<8),hashEscape:Boolean(a.isInternetExplorer()&&a.getInternetExplorerMajorVersion()<7)};a.isEmptyObject=function(b){for(var c in b)return false;return true};a.cloneObject=function(b){if(b){b=i.stringify(b);b=i.parse(b)}else b=
{};return b};a.getRootUrl=function(){var b=g.location.protocol+"//"+(g.location.hostname||g.location.host);if(g.location.port)b+=":"+g.location.port;b+="/";return b};a.getBaseHref=function(){var b=g.getElementsByTagName("base"),c=null;c="";if(b.length===1){c=b[0];c=c.href.replace(/[^\/]+$/,"")}if(c=c.replace(/\/+$/,""))c+="/";return c};a.getBaseUrl=function(){return a.getBaseHref()||a.getBasePageUrl()||a.getRootUrl()};a.getPageUrl=function(){return((a.getState(false,false)||{}).url||g.location.href).replace(/\/+$/,
"").replace(/[^\/]+$/,function(b){return/\./.test(b)?b:b+"/"})};a.getBasePageUrl=function(){return g.location.href.replace(/[#\?].*/,"").replace(/[^\/]+$/,function(b){return/[^\/]$/.test(b)?"":b}).replace(/\/+$/,"")+"/"};a.getFullUrl=function(b,c){var d=b,e=b.substring(0,1);c=typeof c==="undefined"?true:c;/[a-z]+\:\/\//.test(b)||(d=e==="/"?a.getRootUrl()+b.replace(/^\/+/,""):e==="#"?a.getPageUrl().replace(/#.*/,"")+b:e==="?"?a.getPageUrl().replace(/[\?#].*/,"")+b:c?a.getBaseUrl()+b.replace(/^(\.\/)+/,
""):a.getBasePageUrl()+b.replace(/^(\.\/)+/,""));return d.replace(/\#$/,"")};a.getShortUrl=function(b){b=b;var c=a.getBaseUrl(),d=a.getRootUrl();if(a.emulated.pushState)b=b.replace(c,"");b=b.replace(d,"/");if(a.isTraditionalAnchor(b))b="./"+b;return b=b.replace(/^(\.\/)+/g,"./").replace(/\#$/,"")};a.store=m?m.store("History.store")||{}:{};a.store.idToState=a.store.idToState||{};a.store.urlToId=a.store.urlToId||{};a.store.stateToId=a.store.stateToId||{};a.idToState=a.idToState||{};a.stateToId=a.stateToId||
{};a.urlToId=a.urlToId||{};a.storedStates=a.storedStates||[];a.savedStates=a.savedStates||[];a.getState=function(b,c){if(typeof b==="undefined")b=true;if(typeof c==="undefined")c=true;var d=a.getLastSavedState();if(!d&&c)d=a.createStateObject();if(b){d=a.cloneObject(d);d.url=d.cleanUrl||d.url}return d};a.getIdByState=function(b){var c=a.extractId(b.url);if(!c){var d=a.getStateString(b);if(typeof a.stateToId[d]!=="undefined")c=a.stateToId[d];else if(typeof a.store.stateToId[d]!=="undefined")c=a.store.stateToId[d];
else{for(;;){c=String(Math.floor(Math.random()*1E3));if(typeof a.idToState[c]==="undefined"&&typeof a.store.idToState[c]==="undefined")break}a.stateToId[d]=c;a.idToState[c]=b}}return c};a.normalizeState=function(b){if(!b||typeof b!=="object")b={};if(typeof b.normalized!=="undefined")return b;if(!b.data||typeof b.data!=="object")b.data={};var c={};c.normalized=true;c.title=b.title||"";c.url=a.getFullUrl(a.unescapeString(b.url||g.location.href));c.hash=a.getShortUrl(c.url);c.data=a.cloneObject(b.data);
c.id=a.getIdByState(c);c.cleanUrl=c.url.replace(/\??\&_suid.*/,"");c.url=c.cleanUrl;b=!a.isEmptyObject(c.data);if(c.title||b){c.hash=a.getShortUrl(c.url).replace(/\??\&_suid.*/,"");/\?/.test(c.hash)||(c.hash+="?");c.hash+="&_suid="+c.id}c.hashedUrl=a.getFullUrl(c.hash);if((a.emulated.pushState||a.bugs.safariPoll)&&a.hasUrlDuplicate(c))c.url=c.hashedUrl;return c};a.createStateObject=function(b,c,d){b={data:b,title:c,url:d};return b=a.normalizeState(b)};a.getStateById=function(b){b=String(b);return a.idToState[b]||
a.store.idToState[b]||l};a.getStateString=function(b){b={data:a.normalizeState(b).data,title:b.title,url:b.url};return i.stringify(b)};a.getStateId=function(b){return a.normalizeState(b).id};a.getHashByState=function(b){return a.normalizeState(b).hash};a.extractId=function(b){return((b=/(.*)\&_suid=([0-9]+)$/.exec(b))?String(b[2]||""):"")||false};a.isTraditionalAnchor=function(b){return!/[\/\?\.]/.test(b)};a.extractState=function(b,c){var d=null;c=c||false;var e=a.extractId(b);if(e)d=a.getStateById(e);
if(!d){var h=a.getFullUrl(b);if(e=a.getIdByUrl(h)||false)d=a.getStateById(e);if(!d&&c&&!a.isTraditionalAnchor(b))d=a.createStateObject(null,null,h)}return d};a.getIdByUrl=function(b){return a.urlToId[b]||a.store.urlToId[b]||l};a.getLastSavedState=function(){return a.savedStates[a.savedStates.length-1]||l};a.getLastStoredState=function(){return a.storedStates[a.storedStates.length-1]||l};a.hasUrlDuplicate=function(b){var c=false;return c=(c=a.extractState(b.url))&&c.id!==b.id};a.storeState=function(b){a.urlToId[b.url]=
b.id;a.storedStates.push(a.cloneObject(b));return b};a.isLastSavedState=function(b){var c=false;if(a.savedStates.length){b=b.id;c=a.getLastSavedState().id;c=b===c}return c};a.saveState=function(b){if(a.isLastSavedState(b))return false;a.savedStates.push(a.cloneObject(b));return true};a.getStateByIndex=function(b){var c=null;return c=typeof b==="undefined"?a.savedStates[a.savedStates.length-1]:b<0?a.savedStates[a.savedStates.length+b]:a.savedStates[b]};a.getHash=function(){return a.unescapeHash(g.location.hash)};
a.unescapeString=function(b){b=b;for(var c;;){c=f.unescape(b);if(c===b)break;b=c}return b};a.unescapeHash=function(b){b=a.normalizeHash(b);return b=a.unescapeString(b)};a.normalizeHash=function(b){return b.replace(/[^#]*#/,"").replace(/#.*/,"")};a.setHash=function(b,c){if(c!==false&&a.busy()){a.pushQueue({scope:a,callback:a.setHash,args:arguments,queue:c});return false}var d=a.escapeHash(b);a.busy(true);var e=a.extractState(b,true);if(e&&!a.emulated.pushState)a.pushState(e.data,e.title,e.url,false);
else if(g.location.hash!==d)if(a.bugs.setHash){e=a.getPageUrl();a.pushState(null,null,e+"#"+d,false)}else g.location.hash=d;return a};a.escapeHash=function(b){b=a.normalizeHash(b);b=f.escape(b);a.bugs.hashEscape||(b=b.replace(/\%21/g,"!").replace(/\%26/g,"&").replace(/\%3D/g,"=").replace(/\%3F/g,"?"));return b};a.getHashByUrl=function(b){b=String(b).replace(/([^#]*)#?([^#]*)#?(.*)/,"$2");return b=a.unescapeHash(b)};a.setTitle=function(b){var c=b.title;if(!c){var d=a.getStateByIndex(0);if(d&&d.url===
b.url)c=d.title||a.options.initialTitle}try{g.getElementsByTagName("title")[0].innerHTML=c.replace("<","&lt;").replace(">","&gt;").replace(" & "," &amp; ")}catch(e){}g.title=c;return a};a.queues=[];a.busy=function(b){if(typeof b!=="undefined")a.busy.flag=b;else if(typeof a.busy.flag==="undefined")a.busy.flag=false;if(!a.busy.flag){q(a.busy.timeout);var c=function(){if(!a.busy.flag)for(var d=a.queues.length-1;d>=0;--d){var e=a.queues[d];if(e.length!==0){e=e.shift();a.fireQueueItem(e);a.busy.timeout=
p(c,a.options.busyDelay)}}};a.busy.timeout=p(c,a.options.busyDelay)}return a.busy.flag};a.fireQueueItem=function(b){return b.callback.apply(b.scope||a,b.args||[])};a.pushQueue=function(b){a.queues[b.queue||0]=a.queues[b.queue||0]||[];a.queues[b.queue||0].push(b);return a};a.queue=function(b,c){if(typeof b==="function")b={callback:b};if(typeof c!=="undefined")b.queue=c;a.busy()?a.pushQueue(b):a.fireQueueItem(b);return a};a.clearQueue=function(){a.busy.flag=false;a.queues=[];return a};a.stateChanged=
false;a.doubleChecker=false;a.doubleCheckComplete=function(){a.stateChanged=true;a.doubleCheckClear();return a};a.doubleCheckClear=function(){if(a.doubleChecker){q(a.doubleChecker);a.doubleChecker=false}return a};a.doubleCheck=function(b){a.stateChanged=false;a.doubleCheckClear();if(a.bugs.ieDoubleCheck)a.doubleChecker=p(function(){a.doubleCheckClear();a.stateChanged||b();return true},a.options.doubleCheckInterval);return a};a.safariStatePoll=function(){var b=a.extractState(g.location.href);if(!a.isLastSavedState(b)){b||
a.createStateObject();a.Adapter.trigger(f,"popstate");return a}};a.back=function(b){if(b!==false&&a.busy()){a.pushQueue({scope:a,callback:a.back,args:arguments,queue:b});return false}a.busy(true);a.doubleCheck(function(){a.back(false)});n.go(-1);return true};a.forward=function(b){if(b!==false&&a.busy()){a.pushQueue({scope:a,callback:a.forward,args:arguments,queue:b});return false}a.busy(true);a.doubleCheck(function(){a.forward(false)});n.go(1);return true};a.go=function(b,c){var d;if(b>0)for(d=1;d<=
b;++d)a.forward(c);else if(b<0)for(d=-1;d>=b;--d)a.back(c);else throw Error("History.go: History.go requires a positive or negative integer passed.");return a};a.saveState(a.storeState(a.extractState(g.location.href,true)));if(m){a.onUnload=function(){var b=m.store("History.store")||{},c;b.idToState=b.idToState||{};b.urlToId=b.urlToId||{};b.stateToId=b.stateToId||{};for(c in a.idToState)if(a.idToState.hasOwnProperty(c))b.idToState[c]=a.idToState[c];for(c in a.urlToId)if(a.urlToId.hasOwnProperty(c))b.urlToId[c]=
a.urlToId[c];for(c in a.stateToId)if(a.stateToId.hasOwnProperty(c))b.stateToId[c]=a.stateToId[c];a.store=b;m.store("History.store",b)};r(a.onUnload,a.options.storeInterval);a.Adapter.bind(f,"beforeunload",a.onUnload);a.Adapter.bind(f,"unload",a.onUnload)}if(a.emulated.pushState){var s=function(){};a.pushState=a.pushState||s;a.replaceState=a.replaceState||s}else{a.onPopState=function(b){a.doubleCheckComplete();var c=a.getHash();if(c){if(b=a.extractState(c||g.location.href,true))a.replaceState(b.data,
b.title,b.url,false);else{a.Adapter.trigger(f,"anchorchange");a.busy(false)}return a.expectedStateId=false}c=false;b=b||{};if(typeof b.state==="undefined")if(typeof b.originalEvent!=="undefined"&&typeof b.originalEvent.state!=="undefined")b.state=b.originalEvent.state||false;else if(typeof b.event!=="undefined"&&typeof b.event.state!=="undefined")b.state=b.event.state||false;b.state=b.state||false;(c=b.state?a.getStateById(b.state):a.expectedStateId?a.getStateById(a.expectedStateId):a.extractState(g.location.href))||
(c=a.createStateObject(null,null,g.location.href));a.expectedStateId=false;if(a.isLastSavedState(c)){a.busy(false);return false}a.storeState(c);a.saveState(c);a.setTitle(c);a.Adapter.trigger(f,"statechange");a.busy(false);return true};a.Adapter.bind(f,"popstate",a.onPopState);a.pushState=function(b,c,d,e){if(a.getHashByUrl(d)&&a.emulated.pushState)throw Error("History.js does not support states with fragement-identifiers (hashes/anchors).");if(e!==false&&a.busy()){a.pushQueue({scope:a,callback:a.pushState,
args:arguments,queue:e});return false}a.busy(true);var h=a.createStateObject(b,c,d);if(a.isLastSavedState(h))a.busy(false);else{a.storeState(h);a.expectedStateId=h.id;n.pushState(h.id,h.title,h.url);a.Adapter.trigger(f,"popstate")}return true};a.replaceState=function(b,c,d,e){if(a.getHashByUrl(d)&&a.emulated.pushState)throw Error("History.js does not support states with fragement-identifiers (hashes/anchors).");if(e!==false&&a.busy()){a.pushQueue({scope:a,callback:a.replaceState,args:arguments,queue:e});
return false}a.busy(true);var h=a.createStateObject(b,c,d);if(a.isLastSavedState(h))a.busy(false);else{a.storeState(h);a.expectedStateId=h.id;n.replaceState(h.id,h.title,h.url);a.Adapter.trigger(f,"popstate")}return true};a.bugs.safariPoll&&r(a.safariStatePoll,a.options.safariPollInterval);if(k.vendor==="Apple Computer, Inc."||(k.appCodeName||"")==="Mozilla"){a.Adapter.bind(f,"hashchange",function(){a.Adapter.trigger(f,"popstate")});a.getHash()&&a.Adapter.onDomLoad(function(){a.Adapter.trigger(f,
"hashchange")})}}};a.init()})(window);
