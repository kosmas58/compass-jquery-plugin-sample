/*
 Public Domain
 @author Benjamin Arthur Lupton <contact@balupton.com>
 @author James Padolsey <https://gist.github.com/527683>
 Public Domain
 @author Benjamin Arthur Lupton <contact@balupton.com>
 New BSD License <http://creativecommons.org/licenses/BSD/>
*/
(function(e,k){var j=e.console||k,f=e.document,h=e.navigator,l=e.sessionStorage||false,n=e.setTimeout,o=e.clearTimeout,p=e.setInterval,r=e.clearInterval,i=e.JSON,s=e.alert,a=e.History=e.History||{},m=e.history;i.stringify=i.stringify||i.encode;i.parse=i.parse||i.decode;if(typeof a.init!=="undefined")throw Error("History.js Core has already been loaded...");a.init=function(){if(typeof a.Adapter==="undefined")return false;typeof a.initCore!=="undefined"&&a.initCore();typeof a.initHtml4!=="undefined"&&
a.initHtml4();return true};a.initCore=function(){if(typeof a.initCore.initialized!=="undefined")return false;else a.initCore.initialized=true;a.options=a.options||{};a.options.hashChangeInterval=a.options.hashChangeInterval||100;a.options.safariPollInterval=a.options.safariPollInterval||500;a.options.doubleCheckInterval=a.options.doubleCheckInterval||500;a.options.storeInterval=a.options.storeInterval||1E3;a.options.busyDelay=a.options.busyDelay||250;a.options.debug=a.options.debug||false;a.options.initialTitle=
a.options.initialTitle||f.title;a.intervalList=[];a.clearAllIntervals=function(){var b,c=a.intervalList;if(typeof c!=="undefined"&&c!==null){for(b=0;b<c.length;b++)r(c[b]);a.intervalList=null}};a.debug=function(){a.options.debug&&a.log.apply(a,arguments)};a.log=function(){var a=!(typeof j==="undefined"||typeof j.log==="undefined"||typeof j.log.apply==="undefined"),c=f.getElementById("log"),d,g,e,h;a?(g=Array.prototype.slice.call(arguments),d=g.shift(),typeof j.debug!=="undefined"?j.debug.apply(j,
[d,g]):j.log.apply(j,[d,g])):d="\n"+arguments[0]+"\n";for(g=1,e=arguments.length;g<e;++g){h=arguments[g];if(typeof h==="object"&&typeof i!=="undefined")try{h=i.stringify(h)}catch(k){}d+="\n"+h+"\n"}c?(c.value+=d+"\n-----\n",c.scrollTop=c.scrollHeight-c.clientHeight):a||s(d);return true};a.getInternetExplorerMajorVersion=function(){var b=a.getInternetExplorerMajorVersion,c;if(typeof a.getInternetExplorerMajorVersion.cached!=="undefined")c=a.getInternetExplorerMajorVersion.cached;else{c=3;for(var d=
f.createElement("div"),g=d.getElementsByTagName("i");(d.innerHTML="<\!--[if gt IE "+ ++c+"]><i></i><![endif]--\>")&&g[0];);c=c>4?c:false}return b.cached=c};a.isInternetExplorer=function(){return a.isInternetExplorer.cached=typeof a.isInternetExplorer.cached!=="undefined"?a.isInternetExplorer.cached:Boolean(a.getInternetExplorerMajorVersion())};a.emulated={pushState:!Boolean(e.history&&e.history.pushState&&e.history.replaceState&&!(/ Mobile\/([1-7][a-z]|(8([abcde]|f(1[0-8]))))/i.test(h.userAgent)||
/AppleWebKit\/5([0-2]|3[0-2])/i.test(h.userAgent))),hashChange:Boolean(!("onhashchange"in e||"onhashchange"in f)||a.isInternetExplorer()&&a.getInternetExplorerMajorVersion()<8)};a.enabled=!a.emulated.pushState;a.bugs={setHash:Boolean(!a.emulated.pushState&&h.vendor==="Apple Computer, Inc."&&/AppleWebKit\/5([0-2]|3[0-3])/.test(h.userAgent)),safariPoll:Boolean(!a.emulated.pushState&&h.vendor==="Apple Computer, Inc."&&/AppleWebKit\/5([0-2]|3[0-3])/.test(h.userAgent)),ieDoubleCheck:Boolean(a.isInternetExplorer()&&
a.getInternetExplorerMajorVersion()<8),hashEscape:Boolean(a.isInternetExplorer()&&a.getInternetExplorerMajorVersion()<7)};a.isEmptyObject=function(a){for(var c in a)return false;return true};a.cloneObject=function(a){a?(a=i.stringify(a),a=i.parse(a)):a={};return a};a.getRootUrl=function(){var a=f.location.protocol+"//"+(f.location.hostname||f.location.host);f.location.port&&(a+=":"+f.location.port);a+="/";return a};a.getBaseHref=function(){var a=f.getElementsByTagName("base"),c=null,c="";a.length===
1&&(c=a[0],c=c.href.replace(/[^\/]+$/,""));(c=c.replace(/\/+$/,""))&&(c+="/");return c};a.getBaseUrl=function(){return a.getBaseHref()||a.getBasePageUrl()||a.getRootUrl()};a.getPageUrl=function(){return((a.getState(false,false)||{}).url||f.location.href).replace(/\/+$/,"").replace(/[^\/]+$/,function(a){return/\./.test(a)?a:a+"/"})};a.getBasePageUrl=function(){return f.location.href.replace(/[#\?].*/,"").replace(/[^\/]+$/,function(a){return/[^\/]$/.test(a)?"":a}).replace(/\/+$/,"")+"/"};a.getFullUrl=
function(b,c){var d=b,g=b.substring(0,1),c=typeof c==="undefined"?true:c;/[a-z]+\:\/\//.test(b)||(d=g==="/"?a.getRootUrl()+b.replace(/^\/+/,""):g==="#"?a.getPageUrl().replace(/#.*/,"")+b:g==="?"?a.getPageUrl().replace(/[\?#].*/,"")+b:c?a.getBaseUrl()+b.replace(/^(\.\/)+/,""):a.getBasePageUrl()+b.replace(/^(\.\/)+/,""));return d.replace(/\#$/,"")};a.getShortUrl=function(b){var c=a.getBaseUrl(),d=a.getRootUrl();a.emulated.pushState&&(b=b.replace(c,""));b=b.replace(d,"/");a.isTraditionalAnchor(b)&&(b=
"./"+b);return b=b.replace(/^(\.\/)+/g,"./").replace(/\#$/,"")};a.store={};a.idToState=a.idToState||{};a.stateToId=a.stateToId||{};a.urlToId=a.urlToId||{};a.storedStates=a.storedStates||[];a.savedStates=a.savedStates||[];a.normalizeStore=function(){a.store.idToState=a.store.idToState||{};a.store.urlToId=a.store.urlToId||{};a.store.stateToId=a.store.stateToId||{}};a.getState=function(b,c){typeof b==="undefined"&&(b=true);typeof c==="undefined"&&(c=true);var d=a.getLastSavedState();!d&&c&&(d=a.createStateObject());
if(b)d=a.cloneObject(d),d.url=d.cleanUrl||d.url;return d};a.getIdByState=function(b){var c=a.extractId(b.url),d;if(!c)if(d=a.getStateString(b),typeof a.stateToId[d]!=="undefined")c=a.stateToId[d];else if(typeof a.store.stateToId[d]!=="undefined")c=a.store.stateToId[d];else{for(;;)if(c=(new Date).getTime()+String(Math.random()).replace(/\D/g,""),typeof a.idToState[c]==="undefined"&&typeof a.store.idToState[c]==="undefined")break;a.stateToId[d]=c;a.idToState[c]=b}return c};a.normalizeState=function(b){var c;
if(!b||typeof b!=="object")b={};if(typeof b.normalized!=="undefined")return b;if(!b.data||typeof b.data!=="object")b.data={};c={normalized:true};c.title=b.title||"";c.url=a.getFullUrl(a.unescapeString(b.url||f.location.href));c.hash=a.getShortUrl(c.url);c.data=a.cloneObject(b.data);c.id=a.getIdByState(c);c.cleanUrl=c.url.replace(/\??\&_suid.*/,"");c.url=c.cleanUrl;b=!a.isEmptyObject(c.data);if(c.title||b)c.hash=a.getShortUrl(c.url).replace(/\??\&_suid.*/,""),/\?/.test(c.hash)||(c.hash+="?"),c.hash+=
"&_suid="+c.id;c.hashedUrl=a.getFullUrl(c.hash);if((a.emulated.pushState||a.bugs.safariPoll)&&a.hasUrlDuplicate(c))c.url=c.hashedUrl;return c};a.createStateObject=function(b,c,d){b={data:b,title:c,url:d};return b=a.normalizeState(b)};a.getStateById=function(b){b=String(b);return a.idToState[b]||a.store.idToState[b]||k};a.getStateString=function(b){b={data:a.normalizeState(b).data,title:b.title,url:b.url};return i.stringify(b)};a.getStateId=function(b){return a.normalizeState(b).id};a.getHashByState=
function(b){return a.normalizeState(b).hash};a.extractId=function(a){return((a=/(.*)\&_suid=([0-9]+)$/.exec(a))?String(a[2]||""):"")||false};a.isTraditionalAnchor=function(a){return!/[\/\?\.]/.test(a)};a.extractState=function(b,c){var d=null,g,e,c=c||false;(g=a.extractId(b))&&(d=a.getStateById(g));d||(e=a.getFullUrl(b),(g=a.getIdByUrl(e)||false)&&(d=a.getStateById(g)),!d&&c&&!a.isTraditionalAnchor(b)&&(d=a.createStateObject(null,null,e)));return d};a.getIdByUrl=function(b){return a.urlToId[b]||a.store.urlToId[b]||
k};a.getLastSavedState=function(){return a.savedStates[a.savedStates.length-1]||k};a.getLastStoredState=function(){return a.storedStates[a.storedStates.length-1]||k};a.hasUrlDuplicate=function(b){var c=false;return c=(c=a.extractState(b.url))&&c.id!==b.id};a.storeState=function(b){a.urlToId[b.url]=b.id;a.storedStates.push(a.cloneObject(b));return b};a.isLastSavedState=function(b){var c=false;if(a.savedStates.length)b=b.id,c=a.getLastSavedState(),c=c.id,c=b===c;return c};a.saveState=function(b){if(a.isLastSavedState(b))return false;
a.savedStates.push(a.cloneObject(b));return true};a.getStateByIndex=function(b){var c=null;return c=typeof b==="undefined"?a.savedStates[a.savedStates.length-1]:b<0?a.savedStates[a.savedStates.length+b]:a.savedStates[b]};a.getHash=function(){return a.unescapeHash(f.location.hash)};a.unescapeString=function(a){for(var c;;){c=e.unescape(a);if(c===a)break;a=c}return a};a.unescapeHash=function(b){b=a.normalizeHash(b);return b=a.unescapeString(b)};a.normalizeHash=function(a){return a.replace(/[^#]*#/,
"").replace(/#.*/,"")};a.setHash=function(b,c){var d,e;if(c!==false&&a.busy())return a.pushQueue({scope:a,callback:a.setHash,args:arguments,queue:c}),false;d=a.escapeHash(b);a.busy(true);if((e=a.extractState(b,true))&&!a.emulated.pushState)a.pushState(e.data,e.title,e.url,false);else if(f.location.hash!==d)a.bugs.setHash?(e=a.getPageUrl(),a.pushState(null,null,e+"#"+d,false)):f.location.hash=d;return a};a.escapeHash=function(b){b=a.normalizeHash(b);b=e.escape(b);a.bugs.hashEscape||(b=b.replace(/\%21/g,
"!").replace(/\%26/g,"&").replace(/\%3D/g,"=").replace(/\%3F/g,"?"));return b};a.getHashByUrl=function(b){b=String(b).replace(/([^#]*)#?([^#]*)#?(.*)/,"$2");return b=a.unescapeHash(b)};a.setTitle=function(b){var c=b.title,d;c||(d=a.getStateByIndex(0))&&d.url===b.url&&(c=d.title||a.options.initialTitle);try{f.getElementsByTagName("title")[0].innerHTML=c.replace("<","&lt;").replace(">","&gt;").replace(" & "," &amp; ")}catch(e){}f.title=c;return a};a.queues=[];a.busy=function(b){if(typeof b!=="undefined")a.busy.flag=
b;else if(typeof a.busy.flag==="undefined")a.busy.flag=false;if(!a.busy.flag){o(a.busy.timeout);var c=function(){var b,e;if(!a.busy.flag)for(b=a.queues.length-1;b>=0;--b)if(e=a.queues[b],e.length!==0)e=e.shift(),a.fireQueueItem(e),a.busy.timeout=n(c,a.options.busyDelay)};a.busy.timeout=n(c,a.options.busyDelay)}return a.busy.flag};a.busy.flag=false;a.fireQueueItem=function(b){return b.callback.apply(b.scope||a,b.args||[])};a.pushQueue=function(b){a.queues[b.queue||0]=a.queues[b.queue||0]||[];a.queues[b.queue||
0].push(b);return a};a.queue=function(b,c){typeof b==="function"&&(b={callback:b});if(typeof c!=="undefined")b.queue=c;a.busy()?a.pushQueue(b):a.fireQueueItem(b);return a};a.clearQueue=function(){a.busy.flag=false;a.queues=[];return a};a.stateChanged=false;a.doubleChecker=false;a.doubleCheckComplete=function(){a.stateChanged=true;a.doubleCheckClear();return a};a.doubleCheckClear=function(){if(a.doubleChecker)o(a.doubleChecker),a.doubleChecker=false;return a};a.doubleCheck=function(b){a.stateChanged=
false;a.doubleCheckClear();if(a.bugs.ieDoubleCheck)a.doubleChecker=n(function(){a.doubleCheckClear();a.stateChanged||b();return true},a.options.doubleCheckInterval);return a};a.safariStatePoll=function(){var b=a.extractState(f.location.href);if(!a.isLastSavedState(b))return b||a.createStateObject(),a.Adapter.trigger(e,"popstate"),a};a.back=function(b){if(b!==false&&a.busy())return a.pushQueue({scope:a,callback:a.back,args:arguments,queue:b}),false;a.busy(true);a.doubleCheck(function(){a.back(false)});
m.go(-1);return true};a.forward=function(b){if(b!==false&&a.busy())return a.pushQueue({scope:a,callback:a.forward,args:arguments,queue:b}),false;a.busy(true);a.doubleCheck(function(){a.forward(false)});m.go(1);return true};a.go=function(b,c){var d;if(b>0)for(d=1;d<=b;++d)a.forward(c);else if(b<0)for(d=-1;d>=b;--d)a.back(c);else throw Error("History.go: History.go requires a positive or negative integer passed.");return a};if(a.emulated.pushState){var q=function(){};a.pushState=a.pushState||q;a.replaceState=
a.replaceState||q}else a.onPopState=function(b,c){var d=false,d=false;a.doubleCheckComplete();if(d=a.getHash())return(d=a.extractState(d||f.location.href,true))?a.replaceState(d.data,d.title,d.url,false):(a.Adapter.trigger(e,"anchorchange"),a.busy(false)),a.expectedStateId=false;(d=(d=a.Adapter.extractEventData("state",b,c)||false)?a.getStateById(d):a.expectedStateId?a.getStateById(a.expectedStateId):a.extractState(f.location.href))||(d=a.createStateObject(null,null,f.location.href));a.expectedStateId=
false;if(a.isLastSavedState(d))return a.busy(false),false;a.storeState(d);a.saveState(d);a.setTitle(d);a.Adapter.trigger(e,"statechange");a.busy(false);return true},a.Adapter.bind(e,"popstate",a.onPopState),a.pushState=function(b,c,d,g){if(a.getHashByUrl(d)&&a.emulated.pushState)throw Error("History.js does not support states with fragement-identifiers (hashes/anchors).");if(g!==false&&a.busy())return a.pushQueue({scope:a,callback:a.pushState,args:arguments,queue:g}),false;a.busy(true);var f=a.createStateObject(b,
c,d);a.isLastSavedState(f)?a.busy(false):(a.storeState(f),a.expectedStateId=f.id,m.pushState(f.id,f.title,f.url),a.Adapter.trigger(e,"popstate"));return true},a.replaceState=function(b,c,d,f){if(a.getHashByUrl(d)&&a.emulated.pushState)throw Error("History.js does not support states with fragement-identifiers (hashes/anchors).");if(f!==false&&a.busy())return a.pushQueue({scope:a,callback:a.replaceState,args:arguments,queue:f}),false;a.busy(true);var h=a.createStateObject(b,c,d);a.isLastSavedState(h)?
a.busy(false):(a.storeState(h),a.expectedStateId=h.id,m.replaceState(h.id,h.title,h.url),a.Adapter.trigger(e,"popstate"));return true};if(l)try{a.store=i.parse(l.getItem("History.store"))||{}}catch(t){a.store={}}else a.store={};a.normalizeStore();a.Adapter.bind(e,"beforeunload",a.clearAllIntervals);a.Adapter.bind(e,"unload",a.clearAllIntervals);a.saveState(a.storeState(a.extractState(f.location.href,true)));if(l)a.onUnload=function(){var b,c;try{b=i.parse(l.getItem("History.store"))||{}}catch(d){b=
{}}b.idToState=b.idToState||{};b.urlToId=b.urlToId||{};b.stateToId=b.stateToId||{};for(c in a.idToState)a.idToState.hasOwnProperty(c)&&(b.idToState[c]=a.idToState[c]);for(c in a.urlToId)a.urlToId.hasOwnProperty(c)&&(b.urlToId[c]=a.urlToId[c]);for(c in a.stateToId)a.stateToId.hasOwnProperty(c)&&(b.stateToId[c]=a.stateToId[c]);a.store=b;a.normalizeStore();l.setItem("History.store",i.stringify(b))},a.intervalList.push(p(a.onUnload,a.options.storeInterval)),a.Adapter.bind(e,"beforeunload",a.onUnload),
a.Adapter.bind(e,"unload",a.onUnload);if(!a.emulated.pushState&&(a.bugs.safariPoll&&a.intervalList.push(p(a.safariStatePoll,a.options.safariPollInterval)),h.vendor==="Apple Computer, Inc."||(h.appCodeName||"")==="Mozilla"))if(a.Adapter.bind(e,"hashchange",function(){a.Adapter.trigger(e,"popstate")}),a.getHash())a.Adapter.onDomLoad(function(){a.Adapter.trigger(e,"hashchange")})};a.init()})(window);
