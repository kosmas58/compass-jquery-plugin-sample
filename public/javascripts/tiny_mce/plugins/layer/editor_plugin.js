(function(){tinymce.create("tinymce.plugins.Layer",{init:function(b){var a=this;a.editor=b;b.addCommand("mceInsertLayer",a._insertLayer,a);b.addCommand("mceMoveForward",function(){a._move(1)});b.addCommand("mceMoveBackward",function(){a._move(-1)});b.addCommand("mceMakeAbsolute",function(){a._toggleAbsolute()});b.addButton("moveforward",{title:"layer.forward_desc",cmd:"mceMoveForward"});b.addButton("movebackward",{title:"layer.backward_desc",cmd:"mceMoveBackward"});b.addButton("absolute",{title:"layer.absolute_desc",
cmd:"mceMakeAbsolute"});b.addButton("insertlayer",{title:"layer.insertlayer_desc",cmd:"mceInsertLayer"});b.onInit.add(function(){tinymce.isIE&&b.getDoc().execCommand("2D-Position",false,true)});b.onNodeChange.add(a._nodeChange,a);b.onVisualAid.add(a._visualAid,a)},getInfo:function(){return{longname:"Layer",author:"Moxiecode Systems AB",authorurl:"http://tinymce.moxiecode.com",infourl:"http://wiki.moxiecode.com/index.php/TinyMCE:Plugins/layer",version:tinymce.majorVersion+"."+tinymce.minorVersion}},
_nodeChange:function(b,a,d){var c;c=this._getParentLayer(d);if(b.dom.getParent(d,"DIV,P,IMG")){a.setDisabled("absolute",0);a.setDisabled("moveforward",!c);a.setDisabled("movebackward",!c);a.setActive("absolute",c&&c.style.position.toLowerCase()=="absolute")}else{a.setDisabled("absolute",1);a.setDisabled("moveforward",1);a.setDisabled("movebackward",1)}},_visualAid:function(b,a,d){var c=b.dom;tinymce.each(c.select("div,p",a),function(h){if(/^(absolute|relative|static)$/i.test(h.style.position))d?c.addClass(h,
"mceItemVisualAid"):c.removeClass(h,"mceItemVisualAid")})},_move:function(b){var a=this.editor,d,c=[],h=this._getParentLayer(a.selection.getNode()),e=-1,g=-1,f;f=[];tinymce.walk(a.getBody(),function(i){i.nodeType==1&&/^(absolute|relative|static)$/i.test(i.style.position)&&f.push(i)},"childNodes");for(d=0;d<f.length;d++){c[d]=f[d].style.zIndex?parseInt(f[d].style.zIndex):0;if(e<0&&f[d]==h)e=d}if(b<0){for(d=0;d<c.length;d++)if(c[d]<c[e]){g=d;break}if(g>-1){f[e].style.zIndex=c[g];f[g].style.zIndex=c[e]}else if(c[e]>
0)f[e].style.zIndex=c[e]-1}else{for(d=0;d<c.length;d++)if(c[d]>c[e]){g=d;break}if(g>-1){f[e].style.zIndex=c[g];f[g].style.zIndex=c[e]}else f[e].style.zIndex=c[e]+1}a.execCommand("mceRepaint")},_getParentLayer:function(b){return this.editor.dom.getParent(b,function(a){return a.nodeType==1&&/^(absolute|relative|static)$/i.test(a.style.position)})},_insertLayer:function(){var b=this.editor,a=b.dom.getPos(b.dom.getParent(b.selection.getNode(),"*"));b.dom.add(b.getBody(),"div",{style:{position:"absolute",
left:a.x,top:a.y>20?a.y:20,width:100,height:100},"class":"mceItemVisualAid"},b.selection.getContent()||b.getLang("layer.content"))},_toggleAbsolute:function(){var b=this.editor,a=this._getParentLayer(b.selection.getNode());a||(a=b.dom.getParent(b.selection.getNode(),"DIV,P,IMG"));if(a){if(a.style.position.toLowerCase()=="absolute"){b.dom.setStyles(a,{position:"",left:"",top:"",width:"",height:""});b.dom.removeClass(a,"mceItemVisualAid")}else{if(a.style.left=="")a.style.left="20px";if(a.style.top==
"")a.style.top="20px";if(a.style.width=="")a.style.width=a.width?a.width+"px":"100px";if(a.style.height=="")a.style.height=a.height?a.height+"px":"100px";a.style.position="absolute";b.dom.setAttrib(a,"data-mce-style","");b.addVisual(b.getBody())}b.execCommand("mceRepaint");b.nodeChanged()}}});tinymce.PluginManager.add("layer",tinymce.plugins.Layer)})();
