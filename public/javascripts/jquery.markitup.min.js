(function(c){c.fn.markItUp=function(m,f){var b,g,i,q;g=i=q=!1;b={id:"",nameSpace:"",root:"",previewInWindow:"",previewAutoRefresh:!0,previewPosition:"after",previewTemplatePath:"~/templates/preview.html",previewParserPath:"",previewParserVar:"data",resizeHandle:!0,beforeInsert:"",afterInsert:"",onEnter:{},onShiftEnter:{},onCtrlEnter:{},onTab:{},markupSet:[{}]};c.extend(b,m,f);b.root||c("script").each(function(g,i){miuScript=c(i).get(0).src.match(/(.*)jquery\.markitup(\.pack)?\.js$/);if(miuScript!==
null)b.root=miuScript[1]});return this.each(function(){function f(a,c){if(c)return a.replace(/("|')~\//g,"$1"+b.root);return a.replace(/^~\//,b.root)}function m(a){var j=c("<ul></ul>"),b=0;c("li:hover > ul",j).css("display","block");c.each(a,function(){var a=this,d="",h,g;h=a.key?(a.name||"")+" [Ctrl+"+a.key+"]":a.name||"";key=a.key?'accesskey="'+a.key+'"':"";if(a.separator)d=c('<li class="markItUpSeparator">'+(a.separator||"")+"</li>").appendTo(j);else{b++;for(g=s.length-1;g>=0;g--)d+=s[g]+"-";d=
c('<li class="markItUpButton markItUpButton'+d+b+" "+(a.className||"")+'"><a href="" '+key+' title="'+h+'">'+(a.name||"")+"</a></li>").bind("contextmenu",function(){return!1}).click(function(){return!1}).bind("focusin",function(){e.focus()}).mousedown(function(){a.call&&eval(a.call)();setTimeout(function(){r(a)},1);return!1}).hover(function(){c("> ul",this).show();c(document).one("click",function(){c("ul ul",u).hide()})},function(){c("> ul",this).hide()}).appendTo(j);a.dropMenu&&(s.push(b),c(d).addClass("markItUpDropMenu").append(m(a.dropMenu)))}});
s.pop();return j}function E(a){if(a)return a=a.toString(),a=a.replace(/\(\!\(([\s\S]*?)\)\!\)/g,function(a,c){var b=c.split("|!|");return q===!0?b[1]!==void 0?b[1]:b[0]:b[1]===void 0?"":b[0]}),a=a.replace(/\[\!\[([\s\S]*?)\]\!\]/g,function(a,c){var b=c.split(":!:");if(t===!0)return!1;value=prompt(b[0],b[1]?b[1]:"");value===null&&(t=!0);return value});return""}function k(a){c.isFunction(a)&&(a=a(o));return E(a)}function v(a){var c=k(n.openWith),b=k(n.placeHolder),d=k(n.replaceWith),e=k(n.closeWith);
d!==""?block=c+d+e:selection===""&&b!==""?block=c+b+e:(a=a||selection,block=a.match(/ $/)?c+a.replace(/ $/,"")+e+" ":c+a+e);return{block:block,openWith:c,replaceWith:d,placeHolder:b,closeWith:e}}function r(a){var j,f;o=n=a;w();c.extend(o,{line:"",root:b.root,textarea:d,selection:selection||"",caretPosition:h,ctrlKey:g,shiftKey:i,altKey:q});k(b.beforeInsert);k(n.beforeInsert);g===!0&&i===!0&&k(n.beforeMultiInsert);c.extend(o,{line:1});if(g===!0&&i===!0){lines=selection.split(/\r?\n/);a=0;j=lines.length;
for(f=0;f<j;f++)c.trim(lines[f])!==""?(c.extend(o,{line:++a,selection:lines[f]}),lines[f]=v(lines[f]).block):lines[f]="";string={block:lines.join("\n")};start=h;a=string.block.length+(c.browser.opera?j-1:0)}else g===!0?(string=v(selection),start=h+string.openWith.length,a=string.block.length-string.openWith.length-string.closeWith.length,a-=string.block.match(/ $/)?1:0,a-=y(string.block)):i===!0?(string=v(selection),start=h,a=string.block.length,a-=y(string.block)):(string=v(selection),start=h+string.block.length,
a=0,start-=y(string.block));if(selection===""&&string.replaceWith==="")l+=z(string.block),start=h+string.openWith.length,a=string.block.length-string.openWith.length-string.closeWith.length,l=e.val().substring(h,e.val().length).length,l-=z(e.val().substring(0,h));c.extend(o,{caretPosition:h,scrollPosition:x});string.block!==selection&&t===!1?(j=string.block,document.selection?document.selection.createRange().text=j:d.value=d.value.substring(0,h)+j+d.value.substring(h+selection.length,d.value.length),
A(start,a)):l=-1;w();c.extend(o,{line:"",selection:selection});g===!0&&i===!0&&k(n.afterMultiInsert);k(n.afterInsert);k(b.afterInsert);p&&b.previewAutoRefresh&&F();i=q=g=t=!1}function z(a){if(c.browser.opera)return a.length-a.replace(/\n*/g,"").length;return 0}function y(a){if(c.browser.msie)return a.length-a.replace(/\r/g,"").length;return 0}function A(a,b){if(d.createTextRange){if(c.browser.opera&&c.browser.version>=9.5&&b==0)return!1;range=d.createTextRange();range.collapse(!0);range.moveStart("character",
a);range.moveEnd("character",b);range.select()}else d.setSelectionRange&&d.setSelectionRange(a,a+b);d.scrollTop=x;d.focus()}function w(){d.focus();x=d.scrollTop;if(document.selection)if(selection=document.selection,c.browser.msie){var a=selection.createRange(),b=a.duplicate();b.moveToElementText(d);b.setEndPoint("EndToEnd",a);b=b.text.length-a.text.length;h=b-(d.value.substr(0,b).length-d.value.substr(0,b).replace(/\r/g,"").length);selection=a.text}else h=d.selectionStart;else h=d.selectionStart,
selection=d.value.substring(h,d.selectionEnd);return selection}function F(){b.previewParserPath!==""?c.ajax({type:"POST",dataType:"text",global:!1,url:b.previewParserPath,data:b.previewParserVar+"="+encodeURIComponent(e.val()),success:function(a){B(f(a,1))}}):G||c.ajax({url:b.previewTemplatePath,dataType:"text",global:!1,success:function(a){B(f(a,1).replace(/<\!-- content --\>/g,e.val()))}});return!1}function B(a){if(p.document){try{sp=p.document.documentElement.scrollTop}catch(b){sp=0}p.document.open();
p.document.write(a);p.document.close();p.document.documentElement.scrollTop=sp}}function C(a){i=a.shiftKey;q=a.altKey;g=!a.altKey||!a.ctrlKey?a.ctrlKey:!1;if(a.type==="keydown"){if(g===!0&&(li=c("a[accesskey="+String.fromCharCode(a.keyCode)+"]",u).parent("li"),li.length!==0))return g=!1,setTimeout(function(){li.triggerHandler("mousedown")},1),!1;if(a.keyCode===13||a.keyCode===10)return g===!0?(g=!1,r(b.onCtrlEnter),b.onCtrlEnter.keepDefault):i===!0?(i=!1,r(b.onShiftEnter),b.onShiftEnter.keepDefault):
(r(b.onEnter),b.onEnter.keepDefault);if(a.keyCode===9){if(i==!0||g==!0||q==!0)return!1;return l!==-1?(w(),l=e.val().length-l,A(l,0),l=-1,!1):(r(b.onTab),b.onTab.keepDefault)}}}var e,d,s,x,h,l,n,o,u,D,p,G,t;e=c(this);d=this;s=[];t=!1;x=h=0;l=-1;b.previewParserPath=f(b.previewParserPath);b.previewTemplatePath=f(b.previewTemplatePath);(function(){nameSpace=id="";b.id?id='id="'+b.id+'"':e.attr("id")&&(id='id="markItUp'+e.attr("id").substr(0,1).toUpperCase()+e.attr("id").substr(1)+'"');b.nameSpace&&(nameSpace=
'class="'+b.nameSpace+'"');e.wrap("<div "+nameSpace+"></div>");e.wrap("<div "+id+' class="markItUp"></div>');e.wrap('<div class="markItUpContainer"></div>');e.addClass("markItUpEditor");u=c('<div class="markItUpHeader"></div>').insertBefore(e);c(m(b.markupSet)).appendTo(u);D=c('<div class="markItUpFooter"></div>').insertAfter(e);b.resizeHandle===!0&&c.browser.safari!==!0&&(resizeHandle=c('<div class="markItUpResizeHandle"></div>').insertAfter(e).bind("mousedown",function(a){var b=e.height(),d=a.clientY,
f,g;f=function(a){e.css("height",Math.max(20,a.clientY+b-d)+"px");return!1};g=function(){c("html").unbind("mousemove",f).unbind("mouseup",g);return!1};c("html").bind("mousemove",f).bind("mouseup",g)}),D.append(resizeHandle));e.keydown(C).keyup(C);e.bind("insertion",function(a,b){b.target!==!1&&w();d===c.markItUp.focused&&r(b)});e.focus(function(){c.markItUp.focused=this})})()})};c.fn.markItUpRemove=function(){return this.each(function(){var m=c(this).unbind().removeClass("markItUpEditor");m.parent("div").parent("div.markItUp").parent("div").replaceWith(m)})};
c.markItUp=function(m){var f={target:!1};c.extend(f,m);if(f.target)return c(f.target).each(function(){c(this).focus();c(this).trigger("insertion",[f])});else c("textarea").trigger("insertion",[f])}})(jQuery);
