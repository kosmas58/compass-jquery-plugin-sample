(function(c){var L={hintText:"Type in a search term",noResultsText:"No results",searchingText:"Searching...",deleteText:"&times;",searchDelay:300,minChars:1,tokenLimit:null,jsonContainer:null,method:"GET",contentType:"json",queryParam:"q",tokenDelimiter:",",preventDuplicates:false,prePopulate:null,animateDropdown:true,onResult:null,onAdd:null,onDelete:null},C={tokenList:"token-input-list",token:"token-input-token",tokenDelete:"token-input-delete-token",selectedToken:"token-input-selected-token",highlightedToken:"token-input-highlighted-token",
dropdown:"token-input-dropdown",dropdownItem:"token-input-dropdown-item",dropdownItem2:"token-input-dropdown-item2",selectedDropdownItem:"token-input-selected-dropdown-item",inputToken:"token-input-input-token"},m={BEFORE:0,AFTER:1,END:2},h={BACKSPACE:8,TAB:9,ENTER:13,ESCAPE:27,SPACE:32,PAGE_UP:33,PAGE_DOWN:34,END:35,HOME:36,LEFT:37,UP:38,RIGHT:39,DOWN:40,NUMPAD_ENTER:108,COMMA:188};c.fn.tokenInput=function(z,n){var b=c.extend({},L,n||{});return this.each(function(){new c.TokenList(this,z,b)})};c.TokenList=
function(z,n,b){function v(a,d){var e=c("<li><p>"+d+"</p></li>").addClass(b.classes.token).insertBefore(o);c("<span>"+b.deleteText+"</span>").addClass(b.classes.tokenDelete).appendTo(e).click(function(){H(c(this).parent());return false});var f={id:a,name:d};c.data(e.get(0),"tokeninput",f);p=p.slice(0,k).concat([f]).concat(p.slice(k));k++;f=c.map(p,function(j){return j.id});A.val(f.join(b.tokenDelimiter));w+=1;return e}function q(a){var d=c.data(a.get(0),"tokeninput");a=b.onAdd;if(w>0&&b.preventDuplicates){var e=
null;x.children().each(function(){var f=c(this),j=c.data(f.get(0),"tokeninput");if(j&&j.id===d.id){e=f;return false}});if(e){r(e);o.insertAfter(e);g.focus();return}}v(d.id,d.name);if(b.tokenLimit!==null&&w>=b.tokenLimit){g.hide();s()}else{g.focus();g.val("");s();c.isFunction(a)&&a(d)}}function r(a){a.addClass(b.classes.selectedToken);i=a.get(0);g.val("");s()}function y(a,d){a.removeClass(b.classes.selectedToken);i=null;if(d===m.BEFORE){o.insertBefore(a);k--}else if(d===m.AFTER){o.insertAfter(a);k++}else{o.appendTo(x);
k=w}g.focus()}function H(a){var d=c.data(a.get(0),"tokeninput"),e=b.onDelete,f=a.prevAll().length;f>k&&f--;a.remove();i=null;g.focus();p=p.slice(0,f).concat(p.slice(f+1));f<k&&k--;a=c.map(p,function(j){return j.id});A.val(a.join(b.tokenDelimiter));w-=1;b.tokenLimit!==null&&g.show().val("").focus();c.isFunction(e)&&e(d)}function s(){t.hide().empty();l=null}function B(){t.css({position:"absolute",top:c(x).offset().top+c(x).outerHeight(),left:c(x).offset().left,zindex:999}).show()}function D(a,d){if(d&&
d.length){t.empty();var e=c("<ul>").appendTo(t).mouseover(function(f){E(c(f.target).closest("li"))}).mousedown(function(f){q(c(f.target).closest("li"));return false}).hide();c.each(d,function(f,j){var u=c("<li>"+j.name.replace(RegExp("(?![^&;]+;)(?!<[^<>]*)("+a+")(?![^<>]*>)(?![^&;]+;)","gi"),"<b>$1</b>")+"</li>").appendTo(e);f%2?u.addClass(b.classes.dropdownItem):u.addClass(b.classes.dropdownItem2);f===0&&E(u);c.data(u.get(0),"tokeninput",{id:j.id,name:j.name})});B();b.animateDropdown?e.slideDown("fast"):
e.show()}else if(b.noResultsText){t.html("<p>"+b.noResultsText+"</p>");B()}}function E(a){if(a){if(l){c(l).removeClass(b.classes.selectedDropdownItem);l=null}a.addClass(b.classes.selectedDropdownItem);l=a.get(0)}}function I(){var a=g.val().toLowerCase();if(a&&a.length){i&&y(c(i),m.AFTER);if(a.length>=b.minChars){if(b.searchingText){t.html("<p>"+b.searchingText+"</p>");B()}clearTimeout(J);J=setTimeout(function(){M(a)},b.searchDelay)}else s()}}function M(a){var d=F.get(a);if(d)D(a,d);else if(b.url){var e=
{};e.data={};if(b.url.indexOf("?")>-1){d=b.url.split("?");e.url=d[0];d=d[1].split("&");c.each(d,function(f,j){var u=j.split("=");e.data[u[0]]=u[1]})}else e.url=b.url;e.data[b.queryParam]=a;e.type=b.method;e.dataType=b.contentType;if(b.crossDomain)e.dataType="jsonp";e.success=function(f){if(c.isFunction(b.onResult))f=b.onResult.call(this,f);F.add(a,b.jsonContainer?f[b.jsonContainer]:f);if(g.val().toLowerCase()===a)D(a,b.jsonContainer?f[b.jsonContainer]:f)};c.ajax(e)}else if(b.local_data){d=c.grep(b.local_data,
function(f){return f.name.toLowerCase().indexOf(a.toLowerCase())>-1});F.add(a,d);D(a,d)}}if(typeof n==="string"){b.url=n;if(b.crossDomain===undefined)b.crossDomain=b.url.indexOf("://")===-1?false:location.href.split(/\/+/g)[1]!==b.url.split(/\/+/g)[1]}else if(typeof n==="object")b.local_data=n;if(b.classes)b.classes=c.extend({},C,b.classes);else if(b.theme){b.classes={};c.each(C,function(a,d){b.classes[a]=d+"-"+b.theme})}else b.classes=C;var p=[],w=0,F=new c.TokenList.Cache,J,G,g=c('<input type="text"  autocomplete="off">').css({outline:"none"}).focus(function(){if(b.tokenLimit===
null||b.tokenLimit!==w)if(b.hintText){t.html("<p>"+b.hintText+"</p>");B()}}).blur(function(){s()}).bind("keyup keydown blur update",function(){if(G!==(G=g.val())){var a=G.replace(/&/g,"&amp;").replace(/\s/g," ").replace(/</g,"&lt;").replace(/>/g,"&gt;");K.html(a);g.width(K.width()+30)}}).keydown(function(a){var d,e;switch(a.keyCode){case h.LEFT:case h.RIGHT:case h.UP:case h.DOWN:if(c(this).val()){d=null;d=a.keyCode===h.DOWN||a.keyCode===h.RIGHT?c(l).next():c(l).prev();d.length&&E(d);return false}else{d=
o.prev();e=o.next();if(d.length&&d.get(0)===i||e.length&&e.get(0)===i)a.keyCode===h.LEFT||a.keyCode===h.UP?y(c(i),m.BEFORE):y(c(i),m.AFTER);else if((a.keyCode===h.LEFT||a.keyCode===h.UP)&&d.length)r(c(d.get(0)));else if((a.keyCode===h.RIGHT||a.keyCode===h.DOWN)&&e.length)r(c(e.get(0)))}break;case h.BACKSPACE:d=o.prev();if(c(this).val().length)c(this).val().length===1?s():setTimeout(function(){I()},5);else{if(i)H(c(i));else d.length&&r(c(d.get(0)));return false}break;case h.TAB:case h.ENTER:case h.NUMPAD_ENTER:case h.COMMA:if(l){q(c(l));
return false}break;case h.ESCAPE:s();return true;default:String.fromCharCode(a.which)&&setTimeout(function(){I()},5)}}),A=c(z).hide().val("").focus(function(){g.focus()}).blur(function(){g.blur()}),i=null,k=0,l=null,x=c("<ul />").addClass(b.classes.tokenList).click(function(a){if((a=c(a.target).closest("li"))&&a.get(0)&&c.data(a.get(0),"tokeninput")){var d=i;i&&y(c(i),m.END);d===a.get(0)?y(a,m.END):r(a)}else{i&&y(c(i),m.END);g.focus()}}).mouseover(function(a){(a=c(a.target).closest("li"))&&i!==this&&
a.addClass(b.classes.highlightedToken)}).mouseout(function(a){(a=c(a.target).closest("li"))&&i!==this&&a.removeClass(b.classes.highlightedToken)}).insertBefore(A),o=c("<li />").addClass(b.classes.inputToken).appendTo(x).append(g),t=c("<div>").addClass(b.classes.dropdown).appendTo("body").hide(),K=c("<tester/>").insertAfter(g).css({position:"absolute",top:-9999,left:-9999,width:"auto",fontSize:g.css("fontSize"),fontFamily:g.css("fontFamily"),fontWeight:g.css("fontWeight"),letterSpacing:g.css("letterSpacing"),
whiteSpace:"nowrap"});A.val("");(li_data=b.prePopulate||A.data("pre"))&&li_data.length&&c.each(li_data,function(a,d){v(d.id,d.name)})};c.TokenList.Cache=function(z){var n=c.extend({max_size:500},z),b={},v=0;this.add=function(q,r){if(v>n.max_size){b={};v=0}b[q]||(v+=1);b[q]=r};this.get=function(q){return b[q]}}})(jQuery);
