(function(c){var K={hintText:"Type in a search term",noResultsText:"No results",searchingText:"Searching...",deleteText:"&times;",searchDelay:300,minChars:1,tokenLimit:null,jsonContainer:null,method:"GET",contentType:"json",queryParam:"q",tokenDelimiter:",",preventDuplicates:false,prePopulate:null,animateDropdown:true,onResult:null,onAdd:null,onDelete:null},B={tokenList:"token-input-list",token:"token-input-token",tokenDelete:"token-input-delete-token",selectedToken:"token-input-selected-token",highlightedToken:"token-input-highlighted-token",
dropdown:"token-input-dropdown",dropdownItem:"token-input-dropdown-item",dropdownItem2:"token-input-dropdown-item2",selectedDropdownItem:"token-input-selected-dropdown-item",inputToken:"token-input-input-token"},l={BEFORE:0,AFTER:1,END:2},h={BACKSPACE:8,TAB:9,ENTER:13,ESCAPE:27,SPACE:32,PAGE_UP:33,PAGE_DOWN:34,END:35,HOME:36,LEFT:37,UP:38,RIGHT:39,DOWN:40,NUMPAD_ENTER:108,COMMA:188};c.fn.tokenInput=function(w,m){var a=c.extend({},K,m||{});return this.each(function(){new c.TokenList(this,w,a)})};c.TokenList=
function(w,m,a){function t(b,d){var e=c("<li><p>"+d+"</p> </li>").addClass(a.classes.token).insertBefore(n);c("<span>"+a.deleteText+"</span>").addClass(a.classes.tokenDelete).appendTo(e).click(function(){F(c(this).parent());return false});var f={id:b,name:d};c.data(e.get(0),"tokeninput",f);x.push(f);f=c.map(x,function(j){return j.id});y.val(f.join(a.tokenDelimiter));z+=1;return e}function o(b){var d=c.data(b.get(0),"tokeninput");b=a.onAdd;if(z>0&&a.preventDuplicates){var e=null;u.children().each(function(){var f=
c(this),j=c.data(f.get(0),"tokeninput");if(j&&j.id===d.id){e=f;return false}});if(e){p(e);n.insertAfter(e);g.focus();return}}t(d.id,d.name);if(a.tokenLimit!==null&&z>=a.tokenLimit){g.hide();q()}else{g.focus();g.val("");q();c.isFunction(b)&&b(d)}}function p(b){b.addClass(a.classes.selectedToken);i=b.get(0);g.val("");q()}function v(b,d){b.removeClass(a.classes.selectedToken);i=null;if(d===l.BEFORE)n.insertBefore(b);else d===l.AFTER?n.insertAfter(b):n.appendTo(u);g.focus()}function F(b){var d=c.data(b.get(0),
"tokeninput"),e=a.onDelete;b.remove();i=null;g.focus();x=c.grep(x,function(f){return f.id!==d.id});b=c.map(x,function(f){return f.id});y.val(b.join(a.tokenDelimiter));z-=1;a.tokenLimit!==null&&g.show().val("").focus();c.isFunction(e)&&e(d)}function q(){r.hide().empty();k=null}function A(){r.css({position:"absolute",top:c(u).offset().top+c(u).outerHeight(),left:c(u).offset().left,zindex:999}).show()}function C(b,d){if(d&&d.length){r.empty();var e=c("<ul>").appendTo(r).mouseover(function(f){D(c(f.target).closest("li"))}).mousedown(function(f){o(c(f.target).closest("li"));
return false}).hide();c.each(d,function(f,j){var s=c("<li>"+j.name.replace(RegExp("(?![^&;]+;)(?!<[^<>]*)("+b+")(?![^<>]*>)(?![^&;]+;)","gi"),"<b>$1</b>")+"</li>").appendTo(e);f%2?s.addClass(a.classes.dropdownItem):s.addClass(a.classes.dropdownItem2);f===0&&D(s);c.data(s.get(0),"tokeninput",{id:j.id,name:j.name})});A();a.animateDropdown?e.slideDown("fast"):e.show()}else if(a.noResultsText){r.html("<p>"+a.noResultsText+"</p>");A()}}function D(b){if(b){if(k){c(k).removeClass(a.classes.selectedDropdownItem);
k=null}b.addClass(a.classes.selectedDropdownItem);k=b.get(0)}}function G(){var b=g.val().toLowerCase();if(b&&b.length){i&&v(c(i),l.AFTER);if(b.length>=a.minChars){if(a.searchingText){r.html("<p>"+a.searchingText+"</p>");A()}clearTimeout(H);H=setTimeout(function(){L(b)},a.searchDelay)}else q()}}function L(b){var d=I.get(b);if(d)C(b,d);else if(a.url){var e={};e.data={};if(a.url.indexOf("?")>-1){d=a.url.split("?");e.url=d[0];d=d[1].split("&");c.each(d,function(f,j){var s=j.split("=");e.data[s[0]]=s[1]})}else e.url=
a.url;e.data[a.queryParam]=b;e.type=a.method;e.dataType=a.contentType;if(a.crossDomain)e.dataType="jsonp";e.success=function(f){if(c.isFunction(a.onResult))f=a.onResult.call(this,f);I.add(b,a.jsonContainer?f[a.jsonContainer]:f);if(g.val().toLowerCase()===b)C(b,a.jsonContainer?f[a.jsonContainer]:f)};c.ajax(e)}else if(a.local_data){d=c.grep(a.local_data,function(f){return f.name.toLowerCase().indexOf(b.toLowerCase())>-1});C(b,d)}}if(c.type(m)==="string"){a.url=m;if(a.crossDomain===undefined)a.crossDomain=
a.url.indexOf("://")===-1?false:location.href.split(/\/+/g)[1]!==a.url.split(/\/+/g)[1]}else if(c.type(m)==="array")a.local_data=m;if(a.classes)a.classes=c.extend({},B,a.classes);else if(a.theme){a.classes={};c.each(B,function(b,d){a.classes[b]=d+"-"+a.theme})}else a.classes=B;var x=[],z=0,I=new c.TokenList.Cache,H,E,g=c('<input type="text"  autocomplete="off">').css({outline:"none"}).focus(function(){if(a.tokenLimit===null||a.tokenLimit!==z)if(a.hintText){r.html("<p>"+a.hintText+"</p>");A()}}).blur(function(){q()}).bind("keyup keydown blur update",
function(){if(E!==(E=g.val())){var b=E.replace(/&/g,"&amp;").replace(/\s/g," ").replace(/</g,"&lt;").replace(/>/g,"&gt;");J.html(b);g.width(J.width()+30)}}).keydown(function(b){var d,e;switch(b.keyCode){case h.LEFT:case h.RIGHT:case h.UP:case h.DOWN:if(c(this).val()){d=null;d=b.keyCode===h.DOWN||b.keyCode===h.RIGHT?c(k).next():c(k).prev();d.length&&D(d);return false}else{d=n.prev();e=n.next();if(d.length&&d.get(0)===i||e.length&&e.get(0)===i)b.keyCode===h.LEFT||b.keyCode===h.UP?v(c(i),l.BEFORE):v(c(i),
l.AFTER);else if((b.keyCode===h.LEFT||b.keyCode===h.UP)&&d.length)p(c(d.get(0)));else if((b.keyCode===h.RIGHT||b.keyCode===h.DOWN)&&e.length)p(c(e.get(0)))}break;case h.BACKSPACE:d=n.prev();if(c(this).val().length)c(this).val().length===1?q():setTimeout(function(){G()},5);else{if(i)F(c(i));else d.length&&p(c(d.get(0)));return false}break;case h.TAB:case h.ENTER:case h.NUMPAD_ENTER:case h.COMMA:if(k){o(c(k));return false}break;case h.ESCAPE:q();return true;default:String.fromCharCode(b.which)&&setTimeout(function(){G()},
5)}}),y=c(w).hide().val("").focus(function(){g.focus()}).blur(function(){g.blur()}),i=null,k=null,u=c("<ul />").addClass(a.classes.tokenList).click(function(b){if((b=c(b.target).closest("li"))&&b.get(0)&&c.data(b.get(0),"tokeninput")){var d=i;i&&v(c(i),l.END);d===b.get(0)?v(b,l.END):p(b)}else{i&&v(c(i),l.END);g.focus()}}).mouseover(function(b){(b=c(b.target).closest("li"))&&i!==this&&b.addClass(a.classes.highlightedToken)}).mouseout(function(b){(b=c(b.target).closest("li"))&&i!==this&&b.removeClass(a.classes.highlightedToken)}).insertBefore(y),
n=c("<li />").addClass(a.classes.inputToken).appendTo(u).append(g),r=c("<div>").addClass(a.classes.dropdown).appendTo("body").hide(),J=c("<tester/>").insertAfter(g).css({position:"absolute",top:-9999,left:-9999,width:"auto",fontSize:g.css("fontSize"),fontFamily:g.css("fontFamily"),fontWeight:g.css("fontWeight"),letterSpacing:g.css("letterSpacing"),whiteSpace:"nowrap"});y.val("");(li_data=a.prePopulate||y.data("pre"))&&li_data.length&&c.each(li_data,function(b,d){t(d.id,d.name)})};c.TokenList.Cache=
function(w){var m=c.extend({max_size:500},w),a={},t=0;this.add=function(o,p){if(t>m.max_size){a={};t=0}a[o]||(t+=1);a[o]=p};this.get=function(o){return a[o]}}})(jQuery);
