(function(b){var A={method:"GET",queryParam:"q",searchDelay:300,minChars:1,propertyToSearch:"name",jsonContainer:null,contentType:"json",prePopulate:null,processPrePopulate:!1,hintText:"Type in a search term",noResultsText:"No results",searchingText:"Searching...",deleteText:"&times;",animateDropdown:!0,theme:null,resultsFormatter:function(b){return"<li>"+b[this.propertyToSearch]+"</li>"},tokenFormatter:function(b){return"<li><p>"+b[this.propertyToSearch]+"</p></li>"},tokenLimit:null,tokenDelimiter:",",
preventDuplicates:!1,tokenValue:"id",onResult:null,onAdd:null,onDelete:null,onReady:null,idPrefix:"token-input-"},B={tokenList:"token-input-list",token:"token-input-token",tokenDelete:"token-input-delete-token",selectedToken:"token-input-selected-token",highlightedToken:"token-input-highlighted-token",dropdown:"token-input-dropdown",dropdownItem:"token-input-dropdown-item",dropdownItem2:"token-input-dropdown-item2",selectedDropdownItem:"token-input-selected-dropdown-item",inputToken:"token-input-input-token"},
j={BEFORE:0,AFTER:1,END:2},e={BACKSPACE:8,TAB:9,ENTER:13,ESCAPE:27,SPACE:32,PAGE_UP:33,PAGE_DOWN:34,END:35,HOME:36,LEFT:37,UP:38,RIGHT:39,DOWN:40,NUMPAD_ENTER:108,COMMA:188},u={init:function(k,e){var a=b.extend({},A,e||{});return this.each(function(){b(this).data("tokenInputObject",new b.TokenList(this,k,a))})},clear:function(){this.data("tokenInputObject").clear();return this},add:function(b){this.data("tokenInputObject").add(b);return this},remove:function(b){this.data("tokenInputObject").remove(b);
return this},get:function(){return this.data("tokenInputObject").getTokens()}};b.fn.tokenInput=function(b){return u[b]?u[b].apply(this,Array.prototype.slice.call(arguments,1)):u.init.apply(this,arguments)};b.TokenList=function(k,l,a){function I(){a.tokenLimit!==null&&p>=a.tokenLimit&&(g.hide(),q())}function J(f){var d=a.tokenFormatter(f),d=b(d).addClass(a.classes.token).insertBefore(r);b("<span>"+a.deleteText+"</span>").addClass(a.classes.tokenDelete).appendTo(d).click(function(){y(b(this).parent());
i.change();return!1});var c={id:f.id};c[a.propertyToSearch]=f[a.propertyToSearch];b.data(d.get(0),"tokeninput",f);m=m.slice(0,n).concat([c]).concat(m.slice(n));n++;u(m,i);p+=1;a.tokenLimit!==null&&p>=a.tokenLimit&&(g.hide(),q());return d}function C(f){var d=a.onAdd;if(p>0&&a.preventDuplicates){var c=null;s.children().each(function(){var a=b(this),d=b.data(a.get(0),"tokeninput");if(d&&d.id===f.id)return c=a,!1});if(c){x(c);r.insertAfter(c);g.focus();return}}if(a.tokenLimit==null||p<a.tokenLimit)J(f),
I();g.val("");q();b.isFunction(d)&&d.call(i,f)}function x(b){b.addClass(a.classes.selectedToken);h=b.get(0);g.val("");q()}function v(b,d){b.removeClass(a.classes.selectedToken);h=null;d===j.BEFORE?(r.insertBefore(b),n--):d===j.AFTER?(r.insertAfter(b),n++):(r.appendTo(s),n=p);g.focus()}function y(f){var d=b.data(f.get(0),"tokeninput"),c=a.onDelete,w=f.prevAll().length;w>n&&w--;f.remove();h=null;g.focus();m=m.slice(0,w).concat(m.slice(w+1));w<n&&n--;u(m,i);p-=1;a.tokenLimit!==null&&g.show().val("").focus();
b.isFunction(c)&&c.call(i,d)}function u(f,d){var c=b.map(f,function(b){return b[a.tokenValue]});d.val(c.join(a.tokenDelimiter))}function q(){t.hide().empty();o=null}function z(){t.css({position:"absolute",top:b(s).offset().top+b(s).outerHeight(),left:b(s).offset().left,zindex:999}).show()}function D(f,d){if(d&&d.length){t.empty();var c=b("<ul>").appendTo(t).mouseover(function(a){E(b(a.target).closest("li"))}).mousedown(function(a){C(b(a.target).closest("li").data("tokeninput"));i.change();return!1}).hide();
b.each(d,function(d,g){var e=a.resultsFormatter(g),e=e.replace(RegExp("(?![^&;]+;)(?!<[^<>]*)("+g[a.propertyToSearch]+")(?![^<>]*>)(?![^&;]+;)","g"),g[a.propertyToSearch].replace(RegExp("(?![^&;]+;)(?!<[^<>]*)("+f+")(?![^<>]*>)(?![^&;]+;)","gi"),"<b>$1</b>")),e=b(e).appendTo(c);d%2?e.addClass(a.classes.dropdownItem):e.addClass(a.classes.dropdownItem2);d===0&&E(e);b.data(e.get(0),"tokeninput",g)});z();a.animateDropdown?c.slideDown("fast"):c.show()}else a.noResultsText&&(t.html("<p>"+a.noResultsText+
"</p>"),z())}function E(f){f&&(o&&(b(o).removeClass(a.classes.selectedDropdownItem),o=null),f.addClass(a.classes.selectedDropdownItem),o=f.get(0))}function K(){var f=g.val().toLowerCase();f&&f.length&&(h&&v(b(h),j.AFTER),f.length>=a.minChars?(a.searchingText&&(t.html("<p>"+a.searchingText+"</p>"),z()),clearTimeout(L),L=setTimeout(function(){A(f)},a.searchDelay)):q())}function A(f){var d=f+F(),c=G.get(d);if(c)D(f,c);else if(a.url){var c=F(),e={data:{}};c.indexOf("?")>-1?(c=c.split("?"),e.url=c[0],
c=c[1].split("&"),b.each(c,function(a,b){var f=b.split("=");e.data[f[0]]=f[1]})):e.url=c;e.data[a.queryParam]=f;e.type=a.method;e.dataType=a.contentType;if(a.crossDomain)e.dataType="jsonp";e.success=function(c){b.isFunction(a.onResult)&&(c=a.onResult.call(i,c));G.add(d,a.jsonContainer?c[a.jsonContainer]:c);g.val().toLowerCase()===f&&D(f,a.jsonContainer?c[a.jsonContainer]:c)};b.ajax(e)}else a.local_data&&(c=b.grep(a.local_data,function(b){return b[a.propertyToSearch].toLowerCase().indexOf(f.toLowerCase())>
-1}),b.isFunction(a.onResult)&&(c=a.onResult.call(i,c)),G.add(d,c),D(f,c))}function F(){var b=a.url;typeof a.url=="function"&&(b=a.url.call());return b}if(b.type(l)==="string"||b.type(l)==="function"){if(a.url=l,l=F(),a.crossDomain===void 0)a.crossDomain=l.indexOf("://")===-1?!1:location.href.split(/\/+/g)[1]!==l.split(/\/+/g)[1]}else if(typeof l==="object")a.local_data=l;a.classes?a.classes=b.extend({},B,a.classes):a.theme?(a.classes={},b.each(B,function(b,d){a.classes[b]=d+"-"+a.theme})):a.classes=
B;var m=[],p=0,G=new b.TokenList.Cache,L,H,g=b('<input type="text"  autocomplete="off">').css({outline:"none"}).attr("id",a.idPrefix+k.id).focus(function(){if((a.tokenLimit===null||a.tokenLimit!==p)&&a.hintText)t.html("<p>"+a.hintText+"</p>"),z()}).blur(function(){q();b(this).val("")}).bind("keyup keydown blur update",function(){if(H!==(H=g.val())){var b=H.replace(/&/g,"&amp;").replace(/\s/g," ").replace(/</g,"&lt;").replace(/>/g,"&gt;");M.html(b);g.width(M.width()+30)}}).keydown(function(a){var d,
c;switch(a.keyCode){case e.LEFT:case e.RIGHT:case e.UP:case e.DOWN:if(b(this).val())return d=null,d=a.keyCode===e.DOWN||a.keyCode===e.RIGHT?b(o).next():b(o).prev(),d.length&&E(d),!1;else d=r.prev(),c=r.next(),d.length&&d.get(0)===h||c.length&&c.get(0)===h?a.keyCode===e.LEFT||a.keyCode===e.UP?v(b(h),j.BEFORE):v(b(h),j.AFTER):(a.keyCode===e.LEFT||a.keyCode===e.UP)&&d.length?x(b(d.get(0))):(a.keyCode===e.RIGHT||a.keyCode===e.DOWN)&&c.length&&x(b(c.get(0)));break;case e.BACKSPACE:d=r.prev();if(b(this).val().length)b(this).val().length===
1?q():setTimeout(function(){K()},5);else return h?(y(b(h)),i.change()):d.length&&x(b(d.get(0))),!1;break;case e.TAB:case e.ENTER:case e.NUMPAD_ENTER:case e.COMMA:if(o)return C(b(o).data("tokeninput")),i.change(),!1;break;case e.ESCAPE:return q(),!0;default:String.fromCharCode(a.which)&&setTimeout(function(){K()},5)}}),i=b(k).hide().val("").focus(function(){g.focus()}).blur(function(){g.blur()}),h=null,n=0,o=null,s=b("<ul />").addClass(a.classes.tokenList).click(function(a){if((a=b(a.target).closest("li"))&&
a.get(0)&&b.data(a.get(0),"tokeninput")){var d=h;h&&v(b(h),j.END);d===a.get(0)?v(a,j.END):x(a)}else h&&v(b(h),j.END),g.focus()}).mouseover(function(f){(f=b(f.target).closest("li"))&&h!==this&&f.addClass(a.classes.highlightedToken)}).mouseout(function(f){(f=b(f.target).closest("li"))&&h!==this&&f.removeClass(a.classes.highlightedToken)}).insertBefore(i),r=b("<li />").addClass(a.classes.inputToken).appendTo(s).append(g),t=b("<div>").addClass(a.classes.dropdown).appendTo("body").hide(),M=b("<tester/>").insertAfter(g).css({position:"absolute",
top:-9999,left:-9999,width:"auto",fontSize:g.css("fontSize"),fontFamily:g.css("fontFamily"),fontWeight:g.css("fontWeight"),letterSpacing:g.css("letterSpacing"),whiteSpace:"nowrap"});i.val("");k=a.prePopulate||i.data("pre");a.processPrePopulate&&b.isFunction(a.onResult)&&(k=a.onResult.call(i,k));k&&k.length&&b.each(k,function(a,b){J(b);I()});b.isFunction(a.onReady)&&a.onReady.call();this.clear=function(){s.children("li").each(function(){b(this).children("input").length===0&&y(b(this))})};this.add=
function(a){C(a)};this.remove=function(a){s.children("li").each(function(){if(b(this).children("input").length===0){var d=b(this).data("tokeninput"),c=!0,e;for(e in a)if(a[e]!==d[e]){c=!1;break}c&&y(b(this))}})};this.getTokens=function(){return m}};b.TokenList.Cache=function(e){var l=b.extend({max_size:500},e),a={},j=0;this.add=function(b,e){j>l.max_size&&(a={},j=0);a[b]||(j+=1);a[b]=e};this.get=function(b){return a[b]}}})(jQuery);
