(function(b){var A={hintText:"Type in a search term",noResultsText:"No results",searchingText:"Searching...",deleteText:"&times;",searchDelay:300,minChars:1,tokenLimit:null,jsonContainer:null,method:"GET",contentType:"json",queryParam:"q",tokenDelimiter:",",preventDuplicates:!1,prePopulate:null,processPrePopulate:!1,animateDropdown:!0,onResult:null,onAdd:null,onDelete:null,idPrefix:"token-input-"},B={tokenList:"token-input-list",token:"token-input-token",tokenDelete:"token-input-delete-token",selectedToken:"token-input-selected-token",
highlightedToken:"token-input-highlighted-token",dropdown:"token-input-dropdown",dropdownItem:"token-input-dropdown-item",dropdownItem2:"token-input-dropdown-item2",selectedDropdownItem:"token-input-selected-dropdown-item",inputToken:"token-input-input-token"},j={BEFORE:0,AFTER:1,END:2},e={BACKSPACE:8,TAB:9,ENTER:13,ESCAPE:27,SPACE:32,PAGE_UP:33,PAGE_DOWN:34,END:35,HOME:36,LEFT:37,UP:38,RIGHT:39,DOWN:40,NUMPAD_ENTER:108,COMMA:188},i={init:function(k,e){var a=b.extend({},A,e||{});return this.each(function(){b(this).data("tokenInputObject",
new b.TokenList(this,k,a))})},clear:function(){this.data("tokenInputObject").clear();return this},add:function(b){this.data("tokenInputObject").add(b);return this},remove:function(b){this.data("tokenInputObject").remove(b);return this}};b.fn.tokenInput=function(b){return i[b]?i[b].apply(this,Array.prototype.slice.call(arguments,1)):i.init.apply(this,arguments)};b.TokenList=function(k,x,a){function G(){a.tokenLimit!==null&&r>=a.tokenLimit?(g.hide(),s()):g.focus()}function H(c){var d=b("<li><p>"+c.name+
"</p></li>").addClass(a.classes.token).insertBefore(o);b("<span>"+a.deleteText+"</span>").addClass(a.classes.tokenDelete).appendTo(d).click(function(){y(b(this).parent());return!1});var f={id:c.id,name:c.name};b.data(d.get(0),"tokeninput",c);p=p.slice(0,m).concat([f]).concat(p.slice(m));m++;c=b.map(p,function(c){return c.id});l.val(c.join(a.tokenDelimiter));r+=1;return d}function C(c){var d=a.onAdd;if(r>0&&a.preventDuplicates){var f=null;q.children().each(function(){var a=b(this),d=b.data(a.get(0),
"tokeninput");if(d&&d.id===c.id)return f=a,!1});if(f){w(f);o.insertAfter(f);g.focus();return}}if(a.tokenLimit==null||r<a.tokenLimit)H(c),G();g.val("");s();b.isFunction(d)&&d.call(l,c)}function w(c){c.addClass(a.classes.selectedToken);h=c.get(0);g.val("");s()}function u(c,b){c.removeClass(a.classes.selectedToken);h=null;b===j.BEFORE?(o.insertBefore(c),m--):b===j.AFTER?(o.insertAfter(c),m++):(o.appendTo(q),m=r);g.focus()}function y(c){var d=b.data(c.get(0),"tokeninput"),f=a.onDelete,v=c.prevAll().length;
v>m&&v--;c.remove();h=null;g.focus();p=p.slice(0,v).concat(p.slice(v+1));v<m&&m--;c=b.map(p,function(c){return c.id});l.val(c.join(a.tokenDelimiter));r-=1;a.tokenLimit!==null&&g.show().val("").focus();b.isFunction(f)&&f.call(l,d)}function s(){t.hide().empty();n=null}function z(){t.css({position:"absolute",top:b(q).offset().top+b(q).outerHeight(),left:b(q).offset().left,zindex:999}).show()}function i(c,d){if(d&&d.length){t.empty();var f=b("<ul>").appendTo(t).mouseover(function(c){D(b(c.target).closest("li"))}).mousedown(function(c){C(b(c.target).closest("li").data("tokeninput"));
return!1}).hide();b.each(d,function(d,g){var e=b("<li>"+g.name.replace(RegExp("(?![^&;]+;)(?!<[^<>]*)("+c+")(?![^<>]*>)(?![^&;]+;)","gi"),"<b>$1</b>")+"</li>").appendTo(f);d%2?e.addClass(a.classes.dropdownItem):e.addClass(a.classes.dropdownItem2);d===0&&D(e);b.data(e.get(0),"tokeninput",g)});z();a.animateDropdown?f.slideDown("fast"):f.show()}else a.noResultsText&&(t.html("<p>"+a.noResultsText+"</p>"),z())}function D(c){c&&(n&&(b(n).removeClass(a.classes.selectedDropdownItem),n=null),c.addClass(a.classes.selectedDropdownItem),
n=c.get(0))}function I(){var c=g.val().toLowerCase();c&&c.length&&(h&&u(b(h),j.AFTER),c.length>=a.minChars?(a.searchingText&&(t.html("<p>"+a.searchingText+"</p>"),z()),clearTimeout(J),J=setTimeout(function(){A(c)},a.searchDelay)):s())}function A(c){var d=E.get(c);if(d)i(c,d);else if(a.url){var f={data:{}};a.url.indexOf("?")>-1?(d=a.url.split("?"),f.url=d[0],d=d[1].split("&"),b.each(d,function(c,a){var b=a.split("=");f.data[b[0]]=b[1]})):f.url=a.url;f.data[a.queryParam]=c;f.type=a.method;f.dataType=
a.contentType;if(a.crossDomain)f.dataType="jsonp";f.success=function(d){b.isFunction(a.onResult)&&(d=a.onResult.call(l,d));E.add(c,a.jsonContainer?d[a.jsonContainer]:d);g.val().toLowerCase()===c&&i(c,a.jsonContainer?d[a.jsonContainer]:d)};b.ajax(f)}else a.local_data&&(d=b.grep(a.local_data,function(a){return a.name.toLowerCase().indexOf(c.toLowerCase())>-1}),b.isFunction(a.onResult)&&(d=a.onResult.call(l,d)),E.add(c,d),i(c,d))}if(typeof x==="string"){if(a.url=x,a.crossDomain===void 0)a.crossDomain=
a.url.indexOf("://")===-1?!1:location.href.split(/\/+/g)[1]!==a.url.split(/\/+/g)[1]}else if(typeof x==="object")a.local_data=x;a.classes?a.classes=b.extend({},B,a.classes):a.theme?(a.classes={},b.each(B,function(c,b){a.classes[c]=b+"-"+a.theme})):a.classes=B;var p=[],r=0,E=new b.TokenList.Cache,J,F,g=b('<input type="text"  autocomplete="off">').css({outline:"none"}).attr("id",a.idPrefix+k.id).focus(function(){if((a.tokenLimit===null||a.tokenLimit!==r)&&a.hintText)t.html("<p>"+a.hintText+"</p>"),
z()}).blur(function(){s();b(this).val("")}).bind("keyup keydown blur update",function(){if(F!==(F=g.val())){var c=F.replace(/&/g,"&amp;").replace(/\s/g," ").replace(/</g,"&lt;").replace(/>/g,"&gt;");K.html(c);g.width(K.width()+30)}}).keydown(function(c){var a,f;switch(c.keyCode){case e.LEFT:case e.RIGHT:case e.UP:case e.DOWN:if(b(this).val())return a=null,a=c.keyCode===e.DOWN||c.keyCode===e.RIGHT?b(n).next():b(n).prev(),a.length&&D(a),!1;else a=o.prev(),f=o.next(),a.length&&a.get(0)===h||f.length&&
f.get(0)===h?c.keyCode===e.LEFT||c.keyCode===e.UP?u(b(h),j.BEFORE):u(b(h),j.AFTER):(c.keyCode===e.LEFT||c.keyCode===e.UP)&&a.length?w(b(a.get(0))):(c.keyCode===e.RIGHT||c.keyCode===e.DOWN)&&f.length&&w(b(f.get(0)));break;case e.BACKSPACE:a=o.prev();if(b(this).val().length)b(this).val().length===1?s():setTimeout(function(){I()},5);else return h?y(b(h)):a.length&&w(b(a.get(0))),!1;break;case e.TAB:case e.ENTER:case e.NUMPAD_ENTER:case e.COMMA:if(n)return C(b(n).data("tokeninput")),!1;break;case e.ESCAPE:return s(),
!0;default:String.fromCharCode(c.which)&&setTimeout(function(){I()},5)}}),l=b(k).hide().val("").focus(function(){g.focus()}).blur(function(){g.blur()}),h=null,m=0,n=null,q=b("<ul />").addClass(a.classes.tokenList).click(function(a){if((a=b(a.target).closest("li"))&&a.get(0)&&b.data(a.get(0),"tokeninput")){var d=h;h&&u(b(h),j.END);d===a.get(0)?u(a,j.END):w(a)}else h&&u(b(h),j.END),g.focus()}).mouseover(function(c){(c=b(c.target).closest("li"))&&h!==this&&c.addClass(a.classes.highlightedToken)}).mouseout(function(c){(c=
b(c.target).closest("li"))&&h!==this&&c.removeClass(a.classes.highlightedToken)}).insertBefore(l),o=b("<li />").addClass(a.classes.inputToken).appendTo(q).append(g),t=b("<div>").addClass(a.classes.dropdown).appendTo("body").hide(),K=b("<tester/>").insertAfter(g).css({position:"absolute",top:-9999,left:-9999,width:"auto",fontSize:g.css("fontSize"),fontFamily:g.css("fontFamily"),fontWeight:g.css("fontWeight"),letterSpacing:g.css("letterSpacing"),whiteSpace:"nowrap"});l.val("");k=a.prePopulate||l.data("pre");
a.processPrePopulate&&b.isFunction(a.onResult)&&(k=a.onResult.call(l,k));k&&k.length&&b.each(k,function(a,b){H(b);G()});this.clear=function(){q.children("li").each(function(){b(this).children("input").length===0&&y(b(this))})};this.add=function(a){C(a)};this.remove=function(a){q.children("li").each(function(){if(b(this).children("input").length===0){var d=b(this).data("tokeninput"),f=!0,e;for(e in a)if(a[e]!==d[e]){f=!1;break}f&&y(b(this))}})}};b.TokenList.Cache=function(e){var j=b.extend({max_size:500},
e),a={},i=0;this.add=function(b,e){i>j.max_size&&(a={},i=0);a[b]||(i+=1);a[b]=e};this.get=function(b){return a[b]}}})(jQuery);
