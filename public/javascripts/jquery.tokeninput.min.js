(function(b){var z,w,A={method:"GET",queryParam:"q",searchDelay:300,minChars:1,propertyToSearch:"name",jsonContainer:null,contentType:"json",prePopulate:null,processPrePopulate:false,hintText:"Type in a search term",noResultsText:"No results",searchingText:"Searching...",deleteText:"&times;",animateDropdown:true,theme:null,resultsFormatter:function(b){return"<li>"+b[this.propertyToSearch]+"</li>"},tokenFormatter:function(b){return"<li><p>"+b[this.propertyToSearch]+"</p></li>"},tokenLimit:null,tokenDelimiter:",",
preventDuplicates:false,tokenValue:"id",onResult:null,onAdd:null,onDelete:null,onReady:null,idPrefix:"token-input-"},B={tokenList:"token-input-list",token:"token-input-token",tokenDelete:"token-input-delete-token",selectedToken:"token-input-selected-token",highlightedToken:"token-input-highlighted-token",dropdown:"token-input-dropdown",dropdownItem:"token-input-dropdown-item",dropdownItem2:"token-input-dropdown-item2",selectedDropdownItem:"token-input-selected-dropdown-item",inputToken:"token-input-input-token"};
z=0;w=1;var k={init:function(h,j){var a=b.extend({},A,j||{});return this.each(function(){b(this).data("tokenInputObject",new b.TokenList(this,h,a))})},clear:function(){this.data("tokenInputObject").clear();return this},add:function(b){this.data("tokenInputObject").add(b);return this},remove:function(b){this.data("tokenInputObject").remove(b);return this},get:function(){return this.data("tokenInputObject").getTokens()}};b.fn.tokenInput=function(b){return k[b]?k[b].apply(this,Array.prototype.slice.call(arguments,
1)):k.init.apply(this,arguments)};b.TokenList=function(h,j,a){function I(){a.tokenLimit!==null&&o>=a.tokenLimit&&(g.hide(),p())}function J(e){var c=a.tokenFormatter(e),c=b(c).addClass(a.classes.token).insertBefore(q);b("<span>"+a.deleteText+"</span>").addClass(a.classes.tokenDelete).appendTo(c).click(function(){x(b(this).parent());i.change();return false});b.data(c.get(0),"tokeninput",e);l=l.slice(0,m).concat([e]).concat(l.slice(m));m++;k(l,i);o+=1;a.tokenLimit!==null&&o>=a.tokenLimit&&(g.hide(),
p());return c}function C(e){var c=a.onAdd;if(o>0&&a.preventDuplicates){var d=null;r.children().each(function(){var a=b(this),c=b.data(a.get(0),"tokeninput");if(c&&c.id===e.id)return d=a,false});if(d){v(d);q.insertAfter(d);g.focus();return}}if(a.tokenLimit==null||o<a.tokenLimit)J(e),I();g.val("");p();b.isFunction(c)&&c.call(i,e)}function v(b){b.addClass(a.classes.selectedToken);f=b.get(0);g.val("");p()}function t(b,c){b.removeClass(a.classes.selectedToken);f=null;c===z?(q.insertBefore(b),m--):c===
w?(q.insertAfter(b),m++):(q.appendTo(r),m=o);g.focus()}function x(e){var c=b.data(e.get(0),"tokeninput"),d=a.onDelete,u=e.prevAll().length;u>m&&u--;e.remove();f=null;g.focus();l=l.slice(0,u).concat(l.slice(u+1));u<m&&m--;k(l,i);o-=1;a.tokenLimit!==null&&g.show().val("").focus();b.isFunction(d)&&d.call(i,c)}function k(e,c){var d=b.map(e,function(b){return typeof a.tokenValue=="function"?a.tokenValue.call(this,b):b[a.tokenValue]});c.val(d.join(a.tokenDelimiter))}function p(){s.hide().empty();n=null}
function y(){s.css({position:"absolute",top:b(r).offset().top+b(r).outerHeight(),left:b(r).offset().left,"z-index":999}).show()}function D(e,c){if(c&&c.length){s.empty();var d=b("<ul>").appendTo(s).mouseover(function(a){E(b(a.target).closest("li"))}).mousedown(function(a){C(b(a.target).closest("li").data("tokeninput"));i.change();return false}).hide();b.each(c,function(c,g){var f=a.resultsFormatter(g),f=f.replace(RegExp("(?![^&;]+;)(?!<[^<>]*)("+g[a.propertyToSearch]+")(?![^<>]*>)(?![^&;]+;)","g"),
g[a.propertyToSearch].replace(RegExp("(?![^&;]+;)(?!<[^<>]*)("+e+")(?![^<>]*>)(?![^&;]+;)","gi"),"<b>$1</b>")),f=b(f).appendTo(d);c%2?f.addClass(a.classes.dropdownItem):f.addClass(a.classes.dropdownItem2);c===0&&E(f);b.data(f.get(0),"tokeninput",g)});y();a.animateDropdown?d.slideDown("fast"):d.show()}else a.noResultsText&&(s.html("<p>"+a.noResultsText+"</p>"),y())}function E(e){e&&(n&&(b(n).removeClass(a.classes.selectedDropdownItem),n=null),e.addClass(a.classes.selectedDropdownItem),n=e.get(0))}
function K(){var e=g.val().toLowerCase();e&&e.length&&(f&&t(b(f),w),e.length>=a.minChars?(a.searchingText&&(s.html("<p>"+a.searchingText+"</p>"),y()),clearTimeout(L),L=setTimeout(function(){A(e)},a.searchDelay)):p())}function A(e){var c=e+F(),d=G.get(c);if(d)D(e,d);else if(a.url){var d=F(),f={data:{}};d.indexOf("?")>-1?(d=d.split("?"),f.url=d[0],d=d[1].split("&"),b.each(d,function(a,b){var e=b.split("=");f.data[e[0]]=e[1]})):f.url=d;f.data[a.queryParam]=e;f.type=a.method;f.dataType=a.contentType;
if(a.crossDomain)f.dataType="jsonp";f.success=function(d){b.isFunction(a.onResult)&&(d=a.onResult.call(i,d));G.add(c,a.jsonContainer?d[a.jsonContainer]:d);g.val().toLowerCase()===e&&D(e,a.jsonContainer?d[a.jsonContainer]:d)};b.ajax(f)}else a.local_data&&(d=b.grep(a.local_data,function(b){return b[a.propertyToSearch].toLowerCase().indexOf(e.toLowerCase())>-1}),b.isFunction(a.onResult)&&(d=a.onResult.call(i,d)),G.add(c,d),D(e,d))}function F(){var b=a.url;typeof a.url=="function"&&(b=a.url.call());return b}
if(b.type(j)==="string"||b.type(j)==="function"){if(a.url=j,j=F(),a.crossDomain===void 0)a.crossDomain=j.indexOf("://")===-1?false:location.href.split(/\/+/g)[1]!==j.split(/\/+/g)[1]}else if(typeof j==="object")a.local_data=j;a.classes?a.classes=b.extend({},B,a.classes):a.theme?(a.classes={},b.each(B,function(b,c){a.classes[b]=c+"-"+a.theme})):a.classes=B;var l=[],o=0,G=new b.TokenList.Cache,L,H,g=b('<input type="text"  autocomplete="off">').css({outline:"none"}).attr("id",a.idPrefix+h.id).focus(function(){if((a.tokenLimit===
null||a.tokenLimit!==o)&&a.hintText)s.html("<p>"+a.hintText+"</p>"),y()}).blur(function(){p();b(this).val("")}).bind("keyup keydown blur update",function(){if(H!==(H=g.val())){var b=H.replace(/&/g,"&amp;").replace(/\s/g," ").replace(/</g,"&lt;").replace(/>/g,"&gt;");M.html(b);g.width(M.width()+30)}}).keydown(function(a){var c,d;switch(a.keyCode){case 37:case 39:case 38:case 40:if(b(this).val())return c=null,c=a.keyCode===40||a.keyCode===39?b(n).next():b(n).prev(),c.length&&E(c),false;else c=q.prev(),
d=q.next(),c.length&&c.get(0)===f||d.length&&d.get(0)===f?a.keyCode===37||a.keyCode===38?t(b(f),z):t(b(f),w):(a.keyCode===37||a.keyCode===38)&&c.length?v(b(c.get(0))):(a.keyCode===39||a.keyCode===40)&&d.length&&v(b(d.get(0)));break;case 8:c=q.prev();if(b(this).val().length)b(this).val().length===1?p():setTimeout(function(){K()},5);else return f?(x(b(f)),i.change()):c.length&&v(b(c.get(0))),false;break;case 9:case 13:case 108:case 188:if(n)return C(b(n).data("tokeninput")),i.change(),false;break;case 27:return p(),
true;default:String.fromCharCode(a.which)&&setTimeout(function(){K()},5)}}),i=b(h).hide().val("").focus(function(){g.focus()}).blur(function(){g.blur()}),f=null,m=0,n=null,r=b("<ul />").addClass(a.classes.tokenList).click(function(a){if((a=b(a.target).closest("li"))&&a.get(0)&&b.data(a.get(0),"tokeninput")){var c=f;f&&t(b(f),2);c===a.get(0)?t(a,2):v(a)}else f&&t(b(f),2),g.focus()}).mouseover(function(e){(e=b(e.target).closest("li"))&&f!==this&&e.addClass(a.classes.highlightedToken)}).mouseout(function(e){(e=
b(e.target).closest("li"))&&f!==this&&e.removeClass(a.classes.highlightedToken)}).insertBefore(i),q=b("<li />").addClass(a.classes.inputToken).appendTo(r).append(g),s=b("<div>").addClass(a.classes.dropdown).appendTo("body").hide(),M=b("<tester/>").insertAfter(g).css({position:"absolute",top:-9999,left:-9999,width:"auto",fontSize:g.css("fontSize"),fontFamily:g.css("fontFamily"),fontWeight:g.css("fontWeight"),letterSpacing:g.css("letterSpacing"),whiteSpace:"nowrap"});i.val("");h=a.prePopulate||i.data("pre");
a.processPrePopulate&&b.isFunction(a.onResult)&&(h=a.onResult.call(i,h));h&&h.length&&b.each(h,function(a,b){J(b);I()});b.isFunction(a.onReady)&&a.onReady.call();this.clear=function(){r.children("li").each(function(){b(this).children("input").length===0&&x(b(this))})};this.add=function(a){C(a)};this.remove=function(a){r.children("li").each(function(){if(b(this).children("input").length===0){var c=b(this).data("tokeninput"),d=true,f;for(f in a)if(a[f]!==c[f]){d=false;break}d&&x(b(this))}})};this.getTokens=
function(){return l}};b.TokenList.Cache=function(h){var j=b.extend({max_size:500},h),a={},k=0;this.add=function(b,h){k>j.max_size&&(a={},k=0);a[b]||(k+=1);a[b]=h};this.get=function(b){return a[b]}}})(jQuery);
