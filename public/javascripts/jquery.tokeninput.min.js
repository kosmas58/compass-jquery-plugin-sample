(function(c){var L={hintText:"Type in a search term",noResultsText:"No results",searchingText:"Searching...",deleteText:"&times;",searchDelay:300,minChars:1,tokenLimit:null,jsonContainer:null,method:"GET",contentType:"json",queryParam:"q",tokenDelimiter:",",preventDuplicates:false,prePopulate:null,animateDropdown:true,onResult:null,onAdd:null,onDelete:null},C={tokenList:"token-input-list",token:"token-input-token",tokenDelete:"token-input-delete-token",selectedToken:"token-input-selected-token",highlightedToken:"token-input-highlighted-token",
dropdown:"token-input-dropdown",dropdownItem:"token-input-dropdown-item",dropdownItem2:"token-input-dropdown-item2",selectedDropdownItem:"token-input-selected-dropdown-item",inputToken:"token-input-input-token"},m={BEFORE:0,AFTER:1,END:2},h={BACKSPACE:8,TAB:9,ENTER:13,ESCAPE:27,SPACE:32,PAGE_UP:33,PAGE_DOWN:34,END:35,HOME:36,LEFT:37,UP:38,RIGHT:39,DOWN:40,NUMPAD_ENTER:108,COMMA:188};c.fn.tokenInput=function(z,n){var a=c.extend({},L,n||{});return this.each(function(){new c.TokenList(this,z,a)})};c.TokenList=
function(z,n,a){function v(b,d){var e=c("<li><p>"+d+"</p></li>").addClass(a.classes.token).insertBefore(o);c("<span>"+a.deleteText+"</span>").addClass(a.classes.tokenDelete).appendTo(e).click(function(){H(c(this).parent());return false});var f={id:b,name:d};c.data(e.get(0),"tokeninput",f);p=p.slice(0,k).concat([f]).concat(p.slice(k));k++;f=c.map(p,function(j){return j.id});A.val(f.join(a.tokenDelimiter));w+=1;return e}function q(b){var d=c.data(b.get(0),"tokeninput");b=a.onAdd;if(w>0&&a.preventDuplicates){var e=
null;x.children().each(function(){var f=c(this),j=c.data(f.get(0),"tokeninput");if(j&&j.id===d.id){e=f;return false}});if(e){r(e);o.insertAfter(e);g.focus();return}}v(d.id,d.name);if(a.tokenLimit!==null&&w>=a.tokenLimit){g.hide();s()}else{g.focus();g.val("");s();c.isFunction(b)&&b(d)}}function r(b){b.addClass(a.classes.selectedToken);i=b.get(0);g.val("");s()}function y(b,d){b.removeClass(a.classes.selectedToken);i=null;if(d===m.BEFORE){o.insertBefore(b);k--}else if(d===m.AFTER){o.insertAfter(b);k++}else{o.appendTo(x);
k=w}g.focus()}function H(b){var d=c.data(b.get(0),"tokeninput"),e=a.onDelete,f=b.prevAll().length;f>k&&f--;b.remove();i=null;g.focus();p=p.slice(0,f).concat(p.slice(f+1));f<k&&k--;b=c.map(p,function(j){return j.id});A.val(b.join(a.tokenDelimiter));w-=1;a.tokenLimit!==null&&g.show().val("").focus();c.isFunction(e)&&e(d)}function s(){t.hide().empty();l=null}function B(){t.css({position:"absolute",top:c(x).offset().top+c(x).outerHeight(),left:c(x).offset().left,zindex:999}).show()}function D(b,d){if(d&&
d.length){t.empty();var e=c("<ul>").appendTo(t).mouseover(function(f){E(c(f.target).closest("li"))}).mousedown(function(f){q(c(f.target).closest("li"));return false}).hide();c.each(d,function(f,j){var u=c("<li>"+j.name.replace(RegExp("(?![^&;]+;)(?!<[^<>]*)("+b+")(?![^<>]*>)(?![^&;]+;)","gi"),"<b>$1</b>")+"</li>").appendTo(e);f%2?u.addClass(a.classes.dropdownItem):u.addClass(a.classes.dropdownItem2);f===0&&E(u);c.data(u.get(0),"tokeninput",{id:j.id,name:j.name})});B();a.animateDropdown?e.slideDown("fast"):
e.show()}else if(a.noResultsText){t.html("<p>"+a.noResultsText+"</p>");B()}}function E(b){if(b){if(l){c(l).removeClass(a.classes.selectedDropdownItem);l=null}b.addClass(a.classes.selectedDropdownItem);l=b.get(0)}}function I(){var b=g.val().toLowerCase();if(b&&b.length){i&&y(c(i),m.AFTER);if(b.length>=a.minChars){if(a.searchingText){t.html("<p>"+a.searchingText+"</p>");B()}clearTimeout(J);J=setTimeout(function(){M(b)},a.searchDelay)}else s()}}function M(b){var d=F.get(b);if(d)D(b,d);else if(a.url){var e=
{};e.data={};if(a.url.indexOf("?")>-1){d=a.url.split("?");e.url=d[0];d=d[1].split("&");c.each(d,function(f,j){var u=j.split("=");e.data[u[0]]=u[1]})}else e.url=a.url;e.data[a.queryParam]=b;e.type=a.method;e.dataType=a.contentType;if(a.crossDomain)e.dataType="jsonp";e.success=function(f){if(c.isFunction(a.onResult))f=a.onResult.call(this,f);F.add(b,a.jsonContainer?f[a.jsonContainer]:f);if(g.val().toLowerCase()===b)D(b,a.jsonContainer?f[a.jsonContainer]:f)};c.ajax(e)}else if(a.local_data){d=c.grep(a.local_data,
function(f){return f.name.toLowerCase().indexOf(b.toLowerCase())>-1});if(c.isFunction(a.onResult))d=a.onResult.call(this,d);F.add(b,d);D(b,d)}}if(typeof n==="string"){a.url=n;if(a.crossDomain===undefined)a.crossDomain=a.url.indexOf("://")===-1?false:location.href.split(/\/+/g)[1]!==a.url.split(/\/+/g)[1]}else if(typeof n==="object")a.local_data=n;if(a.classes)a.classes=c.extend({},C,a.classes);else if(a.theme){a.classes={};c.each(C,function(b,d){a.classes[b]=d+"-"+a.theme})}else a.classes=C;var p=
[],w=0,F=new c.TokenList.Cache,J,G,g=c('<input type="text"  autocomplete="off">').css({outline:"none"}).focus(function(){if(a.tokenLimit===null||a.tokenLimit!==w)if(a.hintText){t.html("<p>"+a.hintText+"</p>");B()}}).blur(function(){s()}).bind("keyup keydown blur update",function(){if(G!==(G=g.val())){var b=G.replace(/&/g,"&amp;").replace(/\s/g," ").replace(/</g,"&lt;").replace(/>/g,"&gt;");K.html(b);g.width(K.width()+30)}}).keydown(function(b){var d,e;switch(b.keyCode){case h.LEFT:case h.RIGHT:case h.UP:case h.DOWN:if(c(this).val()){d=
null;d=b.keyCode===h.DOWN||b.keyCode===h.RIGHT?c(l).next():c(l).prev();d.length&&E(d);return false}else{d=o.prev();e=o.next();if(d.length&&d.get(0)===i||e.length&&e.get(0)===i)b.keyCode===h.LEFT||b.keyCode===h.UP?y(c(i),m.BEFORE):y(c(i),m.AFTER);else if((b.keyCode===h.LEFT||b.keyCode===h.UP)&&d.length)r(c(d.get(0)));else if((b.keyCode===h.RIGHT||b.keyCode===h.DOWN)&&e.length)r(c(e.get(0)))}break;case h.BACKSPACE:d=o.prev();if(c(this).val().length)c(this).val().length===1?s():setTimeout(function(){I()},
5);else{if(i)H(c(i));else d.length&&r(c(d.get(0)));return false}break;case h.TAB:case h.ENTER:case h.NUMPAD_ENTER:case h.COMMA:if(l){q(c(l));return false}break;case h.ESCAPE:s();return true;default:String.fromCharCode(b.which)&&setTimeout(function(){I()},5)}}),A=c(z).hide().val("").focus(function(){g.focus()}).blur(function(){g.blur()}),i=null,k=0,l=null,x=c("<ul />").addClass(a.classes.tokenList).click(function(b){if((b=c(b.target).closest("li"))&&b.get(0)&&c.data(b.get(0),"tokeninput")){var d=i;
i&&y(c(i),m.END);d===b.get(0)?y(b,m.END):r(b)}else{i&&y(c(i),m.END);g.focus()}}).mouseover(function(b){(b=c(b.target).closest("li"))&&i!==this&&b.addClass(a.classes.highlightedToken)}).mouseout(function(b){(b=c(b.target).closest("li"))&&i!==this&&b.removeClass(a.classes.highlightedToken)}).insertBefore(A),o=c("<li />").addClass(a.classes.inputToken).appendTo(x).append(g),t=c("<div>").addClass(a.classes.dropdown).appendTo("body").hide(),K=c("<tester/>").insertAfter(g).css({position:"absolute",top:-9999,
left:-9999,width:"auto",fontSize:g.css("fontSize"),fontFamily:g.css("fontFamily"),fontWeight:g.css("fontWeight"),letterSpacing:g.css("letterSpacing"),whiteSpace:"nowrap"});A.val("");(li_data=a.prePopulate||A.data("pre"))&&li_data.length&&c.each(li_data,function(b,d){v(d.id,d.name)})};c.TokenList.Cache=function(z){var n=c.extend({max_size:500},z),a={},v=0;this.add=function(q,r){if(v>n.max_size){a={};v=0}a[q]||(v+=1);a[q]=r};this.get=function(q){return a[q]}}})(jQuery);
