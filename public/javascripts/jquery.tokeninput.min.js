(function(b){var y={hintText:"Type in a search term",noResultsText:"No results",searchingText:"Searching...",deleteText:"&times;",searchDelay:300,minChars:1,tokenLimit:null,jsonContainer:null,method:"GET",contentType:"json",queryParam:"q",tokenDelimiter:",",preventDuplicates:!1,prePopulate:null,animateDropdown:!0,onResult:null,onAdd:null,onDelete:null},z={tokenList:"token-input-list",token:"token-input-token",tokenDelete:"token-input-delete-token",selectedToken:"token-input-selected-token",highlightedToken:"token-input-highlighted-token",
dropdown:"token-input-dropdown",dropdownItem:"token-input-dropdown-item",dropdownItem2:"token-input-dropdown-item2",selectedDropdownItem:"token-input-selected-dropdown-item",inputToken:"token-input-input-token"},i={BEFORE:0,AFTER:1,END:2},f={BACKSPACE:8,TAB:9,ENTER:13,ESCAPE:27,SPACE:32,PAGE_UP:33,PAGE_DOWN:34,END:35,HOME:36,LEFT:37,UP:38,RIGHT:39,DOWN:40,NUMPAD_ENTER:108,COMMA:188};b.fn.tokenInput=function(f,i){var a=b.extend({},y,i||{});return this.each(function(){new b.TokenList(this,f,a)})};b.TokenList=
function(J,w,a){function q(c,d){var e=b("<li><p>"+d+"</p></li>").addClass(a.classes.token).insertBefore(m);b("<span>"+a.deleteText+"</span>").addClass(a.classes.tokenDelete).appendTo(e).click(function(){E(b(this).parent());return!1});var j={id:c,name:d};b.data(e.get(0),"tokeninput",j);n=n.slice(0,k).concat([j]).concat(n.slice(k));k++;j=b.map(n,function(a){return a.id});u.val(j.join(a.tokenDelimiter));r+=1;return e}function F(c){var d=b.data(c.get(0),"tokeninput"),c=a.onAdd;if(r>0&&a.preventDuplicates){var e=
null;s.children().each(function(){var a=b(this),c=b.data(a.get(0),"tokeninput");if(c&&c.id===d.id)return e=a,!1});if(e){v(e);m.insertAfter(e);g.focus();return}}q(d.id,d.name);a.tokenLimit!==null&&r>=a.tokenLimit?(g.hide(),o()):(g.focus(),g.val(""),o(),b.isFunction(c)&&c(d))}function v(c){c.addClass(a.classes.selectedToken);h=c.get(0);g.val("");o()}function t(c,b){c.removeClass(a.classes.selectedToken);h=null;b===i.BEFORE?(m.insertBefore(c),k--):b===i.AFTER?(m.insertAfter(c),k++):(m.appendTo(s),k=
r);g.focus()}function E(c){var d=b.data(c.get(0),"tokeninput"),e=a.onDelete,j=c.prevAll().length;j>k&&j--;c.remove();h=null;g.focus();n=n.slice(0,j).concat(n.slice(j+1));j<k&&k--;c=b.map(n,function(a){return a.id});u.val(c.join(a.tokenDelimiter));r-=1;a.tokenLimit!==null&&g.show().val("").focus();b.isFunction(e)&&e(d)}function o(){p.hide().empty();l=null}function x(){p.css({position:"absolute",top:b(s).offset().top+b(s).outerHeight(),left:b(s).offset().left,zindex:999}).show()}function A(c,d){if(d&&
d.length){p.empty();var e=b("<ul>").appendTo(p).mouseover(function(a){B(b(a.target).closest("li"))}).mousedown(function(a){F(b(a.target).closest("li"));return!1}).hide();b.each(d,function(d,g){var f=b("<li>"+g.name.replace(RegExp("(?![^&;]+;)(?!<[^<>]*)("+c+")(?![^<>]*>)(?![^&;]+;)","gi"),"<b>$1</b>")+"</li>").appendTo(e);d%2?f.addClass(a.classes.dropdownItem):f.addClass(a.classes.dropdownItem2);d===0&&B(f);b.data(f.get(0),"tokeninput",{id:g.id,name:g.name})});x();a.animateDropdown?e.slideDown("fast"):
e.show()}else a.noResultsText&&(p.html("<p>"+a.noResultsText+"</p>"),x())}function B(c){c&&(l&&(b(l).removeClass(a.classes.selectedDropdownItem),l=null),c.addClass(a.classes.selectedDropdownItem),l=c.get(0))}function G(){var c=g.val().toLowerCase();c&&c.length&&(h&&t(b(h),i.AFTER),c.length>=a.minChars?(a.searchingText&&(p.html("<p>"+a.searchingText+"</p>"),x()),clearTimeout(H),H=setTimeout(function(){y(c)},a.searchDelay)):o())}function y(c){var d=C.get(c);if(d)A(c,d);else if(a.url){var e={data:{}};
a.url.indexOf("?")>-1?(d=a.url.split("?"),e.url=d[0],d=d[1].split("&"),b.each(d,function(a,c){var b=c.split("=");e.data[b[0]]=b[1]})):e.url=a.url;e.data[a.queryParam]=c;e.type=a.method;e.dataType=a.contentType;if(a.crossDomain)e.dataType="jsonp";e.success=function(d){b.isFunction(a.onResult)&&(d=a.onResult.call(this,d));C.add(c,a.jsonContainer?d[a.jsonContainer]:d);g.val().toLowerCase()===c&&A(c,a.jsonContainer?d[a.jsonContainer]:d)};b.ajax(e)}else a.local_data&&(d=b.grep(a.local_data,function(a){return a.name.toLowerCase().indexOf(c.toLowerCase())>
-1}),b.isFunction(a.onResult)&&(d=a.onResult.call(this,d)),C.add(c,d),A(c,d))}if(typeof w==="string"){if(a.url=w,a.crossDomain===void 0)a.crossDomain=a.url.indexOf("://")===-1?!1:location.href.split(/\/+/g)[1]!==a.url.split(/\/+/g)[1]}else if(typeof w==="object")a.local_data=w;a.classes?a.classes=b.extend({},z,a.classes):a.theme?(a.classes={},b.each(z,function(c,b){a.classes[c]=b+"-"+a.theme})):a.classes=z;var n=[],r=0,C=new b.TokenList.Cache,H,D,g=b('<input type="text"  autocomplete="off">').css({outline:"none"}).focus(function(){if((a.tokenLimit===
null||a.tokenLimit!==r)&&a.hintText)p.html("<p>"+a.hintText+"</p>"),x()}).blur(function(){o()}).bind("keyup keydown blur update",function(){if(D!==(D=g.val())){var a=D.replace(/&/g,"&amp;").replace(/\s/g," ").replace(/</g,"&lt;").replace(/>/g,"&gt;");I.html(a);g.width(I.width()+30)}}).keydown(function(a){var d,e;switch(a.keyCode){case f.LEFT:case f.RIGHT:case f.UP:case f.DOWN:if(b(this).val())return d=null,d=a.keyCode===f.DOWN||a.keyCode===f.RIGHT?b(l).next():b(l).prev(),d.length&&B(d),!1;else d=
m.prev(),e=m.next(),d.length&&d.get(0)===h||e.length&&e.get(0)===h?a.keyCode===f.LEFT||a.keyCode===f.UP?t(b(h),i.BEFORE):t(b(h),i.AFTER):(a.keyCode===f.LEFT||a.keyCode===f.UP)&&d.length?v(b(d.get(0))):(a.keyCode===f.RIGHT||a.keyCode===f.DOWN)&&e.length&&v(b(e.get(0)));break;case f.BACKSPACE:d=m.prev();if(b(this).val().length)b(this).val().length===1?o():setTimeout(function(){G()},5);else return h?E(b(h)):d.length&&v(b(d.get(0))),!1;break;case f.TAB:case f.ENTER:case f.NUMPAD_ENTER:case f.COMMA:if(l)return F(b(l)),
!1;break;case f.ESCAPE:return o(),!0;default:String.fromCharCode(a.which)&&setTimeout(function(){G()},5)}}),u=b(J).hide().val("").focus(function(){g.focus()}).blur(function(){g.blur()}),h=null,k=0,l=null,s=b("<ul />").addClass(a.classes.tokenList).click(function(a){if((a=b(a.target).closest("li"))&&a.get(0)&&b.data(a.get(0),"tokeninput")){var d=h;h&&t(b(h),i.END);d===a.get(0)?t(a,i.END):v(a)}else h&&t(b(h),i.END),g.focus()}).mouseover(function(c){(c=b(c.target).closest("li"))&&h!==this&&c.addClass(a.classes.highlightedToken)}).mouseout(function(c){(c=
b(c.target).closest("li"))&&h!==this&&c.removeClass(a.classes.highlightedToken)}).insertBefore(u),m=b("<li />").addClass(a.classes.inputToken).appendTo(s).append(g),p=b("<div>").addClass(a.classes.dropdown).appendTo("body").hide(),I=b("<tester/>").insertAfter(g).css({position:"absolute",top:-9999,left:-9999,width:"auto",fontSize:g.css("fontSize"),fontFamily:g.css("fontFamily"),fontWeight:g.css("fontWeight"),letterSpacing:g.css("letterSpacing"),whiteSpace:"nowrap"});u.val("");(li_data=a.prePopulate||
u.data("pre"))&&li_data.length&&b.each(li_data,function(a,b){q(b.id,b.name)})};b.TokenList.Cache=function(f){var i=b.extend({max_size:500},f),a={},q=0;this.add=function(b,f){q>i.max_size&&(a={},q=0);a[b]||(q+=1);a[b]=f};this.get=function(b){return a[b]}}})(jQuery);
